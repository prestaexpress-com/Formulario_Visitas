
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Visitas</title>
    <style>
        :root {
            --orange-primary: #ff6500;
            --orange-secondary: #ff7a1a;
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --gray-border: #e9ecef;
            --gray-text: #6c757d;
            --gray-dark: #495057;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.15);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        /* Estilos para Coopexpress (colores verdes) */
        body.coopexpress {
            --orange-primary: #a4c639;
            --orange-secondary: #8fb82e;
        }

        /* Menú de selección de empresa */
        .empresa-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .empresa-selector-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .empresa-selector h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .empresa-selector p {
            color: #666;
            font-size: 16px;
            margin-bottom: 40px;
        }

        .empresa-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .empresa-btn {
            padding: 20px 30px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .empresa-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .empresa-btn.presta {
            background: linear-gradient(135deg, #ff6500, #ff7a1a);
            color: white;
        }

        .empresa-btn.presta:hover {
            background: linear-gradient(135deg, #ff7a1a, #ff8c2e);
        }

        .empresa-btn.coop {
            background: linear-gradient(135deg, #a4c639, #8fb82e);
            color: white;
        }

        .empresa-btn.coop:hover {
            background: linear-gradient(135deg, #8fb82e, #7fa525);
        }

        .empresa-btn img {
            height: 50px;
            width: auto;
        }

        .formulario-container {
            display: none;
        }

        .formulario-container.active {
            display: block;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-light) 0%, var(--white) 100%);
            min-height: 100vh;
            color: var(--gray-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                padding: 24px;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            color: var(--orange-primary);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--gray-text);
            font-size: 14px;
        }

        .progress-bar {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            flex: 1;
            position: relative;
            padding: 0 8px;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--gray-border);
            z-index: 1;
        }

        .progress-step.active:not(:last-child)::after,
        .progress-step.completed:not(:last-child)::after {
            background: var(--orange-primary);
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-border);
            color: var(--gray-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            transition: var(--transition);
        }

        .progress-step.active .step-icon {
            background: var(--orange-primary);
            color: var(--white);
            transform: scale(1.1);
        }

        .progress-step.completed .step-icon {
            background: var(--orange-secondary);
            color: var(--white);
        }

        .step-label {
            font-size: 11px;
            text-align: center;
            color: var(--gray-text);
            font-weight: 500;
            line-height: 1.2;
        }

        .progress-step.active .step-label {
            color: var(--orange-primary);
            font-weight: 600;
        }

        .progress-fill {
            height: 4px;
            background: var(--gray-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-primary), var(--orange-secondary));
            border-radius: 2px;
            transition: width 0.5s ease;
            width: 16.66%;
        }

        .form-container {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .form-step.active {
            display: block !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            color: var(--orange-primary);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 480px) {
            .form-grid.two-columns {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        label .required {
            color: var(--orange-primary);
            margin-left: 4px;
        }

        input, select, textarea {
            padding: 14px 16px;
            border: 2px solid var(--gray-border);
            border-radius: var(--border-radius);
            font-size: 16px;
            background: var(--white);
            transition: var(--transition);
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(255, 101, 0, 0.1);
        }

        input.error, select.error, textarea.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 2px solid var(--gray-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
            min-width: 120px;
            justify-content: center;
        }

        .radio-item:hover, .checkbox-item:hover {
            border-color: var(--orange-secondary);
            background: rgba(255, 101, 0, 0.05);
        }

        .radio-item.selected, .checkbox-item.selected {
            border-color: var(--orange-primary);
            background: rgba(255, 101, 0, 0.1);
            color: var(--orange-primary);
            font-weight: 600;
        }

        .radio-item input, .checkbox-item input {
            display: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .canvas-container {
            border: 2px dashed var(--gray-border);
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
            background: var(--gray-light);
            margin-bottom: 16px;
        }

        .canvas-container.active {
            border-color: var(--orange-primary);
            background: rgba(255, 101, 0, 0.05);
        }

        canvas {
            border: 1px solid var(--gray-border);
            border-radius: var(--border-radius);
            background: var(--white);
            max-width: 100%;
            height: auto;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-tools {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 10px 16px;
            background: var(--white);
            border: 2px solid var(--gray-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .tool-btn.active {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: var(--white);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            border: 2px dashed var(--gray-border);
            border-radius: var(--border-radius);
            background: var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            min-height: 80px;
        }

        .file-label:hover {
            border-color: var(--orange-primary);
            background: rgba(255, 101, 0, 0.05);
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .photo-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .photo-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            border: 2px dashed var(--gray-border);
            border-radius: var(--border-radius);
            background: var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
        }

        .photo-btn:hover {
            border-color: var(--orange-primary);
            background: rgba(255, 101, 0, 0.05);
            transform: translateY(-2px);
        }

        .photo-btn span {
            font-size: 24px;
        }

        .camera-btn:hover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .gallery-btn:hover {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }

        @media (max-width: 480px) {
            .photo-buttons {
                flex-direction: column;
            }
            
            .photo-btn {
                min-height: 70px;
                padding: 12px;
            }
            
            .photo-btn span {
                font-size: 20px;
            }
        }

        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--orange-primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--orange-secondary);
            box-shadow: var(--shadow-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--orange-primary);
            border: 2px solid var(--orange-primary);
        }

        .btn-secondary:hover {
            background: var(--orange-primary);
            color: var(--white);
        }

        .btn-danger {
            background: #dc3545;
            color: var(--white);
            border: 2px solid #dc3545;
            min-width: auto;
            padding: 8px 12px;
        }

        .btn-danger:hover {
            background: #c82333;
            border-color: #c82333;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: var(--white);
            border: 2px solid #28a745;
        }

        .btn-success:hover {
            background: #218838;
            border-color: #218838;
            box-shadow: var(--shadow-hover);
            transform: translateY(-1px);
        }

        /* Estilos para campos dinámicos */
        .dynamic-item {
            margin-bottom: 12px;
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-border);
        }

        .dynamic-item .form-grid {
            margin-bottom: 0;
        }

        .dynamic-item input,
        .dynamic-item select,
        .dynamic-item textarea {
            margin-bottom: 0;
        }

        .dynamic-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dynamic-buttons input {
            flex: 1;
        }

        .dynamic-section {
            margin-bottom: 24px;
        }

        .dynamic-section h4 {
            color: var(--orange-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--orange-primary);
            padding-bottom: 8px;
        }

        /* Mejorar el contenedor de inventario */
        .inventario-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 60px;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 12px;
            color: var(--gray-dark);
        }

        .inventario-item .form-grid {
            gap: 8px;
        }

        /* Asegurar que todo esté contenido */
        .form-container {
            overflow: hidden;
            max-width: 100%;
        }

        .form-step {
            max-width: 100%;
            overflow: hidden;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        /* Mejorar responsividad */
        @media (max-width: 768px) {
            .form-grid.two-columns {
                grid-template-columns: 1fr;
            }
            
            .inventario-header {
                display: none;
            }
            
            .inventario-item .form-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .inventario-item input {
                border: 1px solid var(--gray-border);
                margin-bottom: 8px;
            }
            
            .dynamic-buttons {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Asegurar que los campos dinámicos no se salgan */
        .dynamic-item {
            width: 100%;
            box-sizing: border-box;
        }

        .dynamic-item input,
        .dynamic-item select,
        .dynamic-item textarea {
            width: 100%;
            box-sizing: border-box;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .location-btn {
            background: #28a745;
            color: white;
            border: 2px solid transparent;
        }

        .location-btn:hover {
            background: #218838;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 16px;
            border-radius: var(--border-radius);
            margin: 16px 0;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Auto-save indicator */
        .auto-save {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--orange-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-save.show {
            opacity: 1;
        }

        /* Touch optimizations */
        @media (max-width: 767px) {
            input, select, textarea, .btn {
                min-height: 48px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .canvas-tools {
                gap: 8px;
            }
            
            .tool-btn {
                padding: 12px 16px;
                min-height: 48px;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-border);
            border-top-color: var(--orange-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Menú de selección de empresa -->
    <div class="empresa-selector" id="empresaSelector">
        <div class="empresa-selector-content">
            <h1>Seleccione la Empresa</h1>
            <p>Elija la empresa para la cual va a realizar la verificación</p>
            <div class="empresa-buttons">
                <button class="empresa-btn presta" onclick="seleccionarEmpresa('presta')">
                    <span>Presta Express</span>
                </button>
                <button class="empresa-btn coop" onclick="seleccionarEmpresa('coop')">
                    <span>Coopexpress</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Contenedor del formulario (oculto inicialmente) -->
    <div class="formulario-container" id="formularioContainer">
    <div class="container">
        <header class="header">
            <h1>📋 Formulario de Visitas</h1>
            <p>Complete todos los campos requeridos para registrar la visita</p>
            <div class="form-group" style="margin-top: 15px;">
                <label for="tipoVerificacion" style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de Verificación</label>
                <select id="tipoVerificacion" class="form-control" style="width: 100%; padding: 8px; border: 1px solid var(--gray-border); border-radius: var(--border-radius); background-color: var(--white);">
                    <option value="">Seleccione el tipo de verificación</option>
                    <option value="Domiciliar">Domiciliar</option>
                    <option value="Garantia">Garantía</option>
                    <option value="Laboral">Laboral</option>
                    <option value="SA">S.A</option>
                </select>
            </div>
        </header>

        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-icon">1</div>
                    <div class="step-label">Datos Básicos</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-icon">2</div>
                    <div class="step-label">Vivienda</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-icon">3</div>
                    <div class="step-label">Inquilinos</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-icon">4</div>
                    <div class="step-label">Negocio</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="step-icon">5</div>
                    <div class="step-label">Empleo</div>
                </div>
                <div class="progress-step" data-step="6">
                    <div class="step-icon">6</div>
                    <div class="step-label">Verificación</div>
                </div>
                <div class="progress-step" data-step="7">
                    <div class="step-icon">7</div>
                    <div class="step-label">Croquis y Firmas</div>
                </div>
                <div class="progress-step" data-step="8">
                    <div class="step-icon">8</div>
                    <div class="step-label">Finalizar</div>
                </div>
            </div>
            <div class="progress-fill">
                <div class="progress-bar-fill"></div>
            </div>
        </div>

        <form class="form-container" id="visitForm">
            <!-- Paso 1: Datos Básicos -->
            <div class="form-step active" data-step="1">
                <h2 class="step-title">
                    <span>👤</span> Datos Básicos del Propietario
                </h2>
                <div class="form-grid two-columns">
                    <div class="form-group">
                        <label for="fechaVisita">Fecha de Visita <span class="required">*</span></label>
                        <input type="date" id="fechaVisita" name="fechaVisita" required>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="montoSolicitado">Monto Solicitado <span class="required">*</span></label>
                        <input type="number" id="montoSolicitado" name="montoSolicitado" required min="0" step="0.01" placeholder="Q 0.00">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="nombrePropietario">Nombre del Propietario <span class="required">*</span></label>
                        <input type="text" id="nombrePropietario" name="nombrePropietario" required maxlength="100">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="contadorFisico">Contador Físico</label>
                        <input type="text" id="contadorFisico" name="contadorFisico" maxlength="50">
                    </div>
                    <div class="form-group full-width">
                        <label for="direccion">Dirección <span class="required">*</span></label>
                        <textarea id="direccion" name="direccion" required placeholder="Ingrese la dirección completa"></textarea>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="personaAtiende">Persona que Atendió <span class="required">*</span></label>
                        <input type="text" id="personaAtiende" name="personaAtiende" required maxlength="100">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="parentesco">Parentesco <span class="required">*</span></label>
                        <select id="parentesco" name="parentesco" required>
                            <option value="">Seleccione...</option>
                            <option value="Propietario">Propietario</option>
                            <option value="Esposo/a">Esposo/a</option>
                            <option value="Hijo/a">Hijo/a</option>
                            <option value="Padre/Madre">Padre/Madre</option>
                            <option value="Hermano/a">Hermano/a</option>
                            <option value="Otro familiar">Otro familiar</option>
                            <option value="Inquilino">Inquilino</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="tiempoResidencia">Tiempo de Residir en el Inmueble <span class="required">*</span></label>
                        <input type="text" id="tiempoResidencia" name="tiempoResidencia" required placeholder="Ej: 5 años, 2 meses">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="cui">No. CUI <span class="required">*</span></label>
                        <input type="text" id="cui" name="cui" required pattern="[0-9]{13}" placeholder="1234567890123">
                        <div class="error-message">Ingrese un CUI válido de 13 dígitos</div>
                    </div>
                    <div class="form-group">
                        <label for="telefonoCelular">Teléfono Celular <span class="required">*</span></label>
                        <input type="tel" id="telefonoCelular" name="telefonoCelular" required pattern="[0-9\-\+\s\(\)]{8,15}" placeholder="1234-5678">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="formaAdquisicion">Forma en la que Adquirió el Inmueble <span class="required">*</span></label>
                        <select id="formaAdquisicion" name="formaAdquisicion" required>
                            <option value="">Seleccione...</option>
                            <option value="Compra">Compra</option>
                            <option value="Herencia">Herencia</option>
                            <option value="Donación - Contrato división voluntaria">Donación - Contrato división voluntaria</option>
                        </select>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group full-width">
                        <label for="quienesViven">¿Quiénes Viven en el Inmueble? <span class="required">*</span></label>
                        <textarea id="quienesViven" name="quienesViven" required rows="3" placeholder="Liste las personas que viven en el inmueble con edades y parentesco"></textarea>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="dimensionesInmueble">Dimensiones del Inmueble <span class="required">*</span></label>
                        <input type="text" id="dimensionesInmueble" name="dimensionesInmueble" required placeholder="Ej: 10m x 15m">
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label for="destinoCredito">Destino de Crédito <span class="required">*</span></label>
                        <select id="destinoCredito" name="destinoCredito" required onchange="mostrarOtroDestino()">
                            <option value="">Seleccione...</option>
                            <option value="Mejoras al hogar">Mejoras al hogar</option>
                            <option value="Negocio">Negocio</option>
                            <option value="Educación">Educación</option>
                            <option value="Salud">Salud</option>
                            <option value="Agricultura">Agricultura</option>
                            <option value="Consolidación de deudas">Consolidación de deudas</option>
                            <option value="Pago Hipoteca">Pago Hipoteca</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <div id="otroDestinoContainer" style="display: none; margin-top: 10px;">
                            <input type="text" id="otroDestino" name="otroDestino" class="form-control" placeholder="Especifique el destino del crédito">
                        </div>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Información de la Vivienda -->
            <div class="form-step" data-step="2">
                <h2 class="step-title">
                    <span>🏠</span> Información de la Vivienda
                </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tipo de Vivienda <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="casa" name="tipoVivienda" value="CASA" required>
                                <label for="casa">CASA</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="terreno" name="tipoVivienda" value="TERRENO">
                                <label for="terreno">TERRENO</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="apartamento" name="tipoVivienda" value="APARTAMENTO">
                                <label for="apartamento">APARTAMENTO</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="obraGris" name="tipoVivienda" value="OBRA GRIS">
                                <label for="obraGris">OBRA GRIS</label>
                            </div>
                        </div>
                        <div class="error-message">Seleccione el tipo de vivienda</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Material de Paredes</label>
                        <select id="materialParedes" name="materialParedes">
                            <option value="">Seleccione...</option>
                            <option value="Block">Block</option>
                            <option value="Ladrillo">Ladrillo</option>
                            <option value="Adobe">Adobe</option>
                            <option value="Madera">Madera</option>
                            <option value="Lámina">Lámina</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Material del Techo</label>
                        <select id="materialTecho" name="materialTecho">
                            <option value="">Seleccione...</option>
                            <option value="Lámina">Lámina</option>
                            <option value="Teja">Teja</option>
                            <option value="Terraza">Terraza</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Material del Piso</label>
                        <select id="materialPiso" name="materialPiso">
                            <option value="">Seleccione...</option>
                            <option value="Cerámico">Cerámico</option>
                            <option value="Cemento">Cemento</option>
                            <option value="Tierra">Tierra</option>
                            <option value="Madera">Madera</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroHabitaciones">Número de Habitaciones</label>
                        <input type="number" id="numeroHabitaciones" name="numeroHabitaciones" min="1" max="20">
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroBanos">Número de Baños</label>
                        <input type="number" id="numeroBanos" name="numeroBanos" min="0" max="10">
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Servicios Disponibles</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="agua" name="servicios" value="Agua">
                                <label for="agua">Agua</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="luz" name="servicios" value="Luz">
                                <label for="luz">Luz</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drenaje" name="servicios" value="Drenaje">
                                <label for="drenaje">Drenaje</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="telefono" name="servicios" value="Teléfono">
                                <label for="telefono">Teléfono</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="internet" name="servicios" value="Internet">
                                <label for="internet">Internet</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Condición General de la Vivienda</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="excelente" name="condicionVivienda" value="Excelente">
                                <label for="excelente">Excelente</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="buena" name="condicionVivienda" value="Buena">
                                <label for="buena">Buena</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="regular" name="condicionVivienda" value="Regular">
                                <label for="regular">Regular</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="mala" name="condicionVivienda" value="Mala">
                                <label for="mala">Mala</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="formaIngresoGarita">Forma de Ingreso a Garita</label>
                        <select id="formaIngresoGarita" name="formaIngresoGarita" onchange="mostrarDetalleGarita()">
                            <option value="">Seleccione...</option>
                            <option value="Código">Código</option>
                            <option value="Marbete">Marbete</option>
                            <option value="Entrada Libre">Entrada Libre</option>
                        </select>
                        <div id="detalleCodigoContainer" style="display: none; margin-top: 10px;">
                            <label for="detalleCodigo">Código de acceso:</label>
                            <input type="text" id="detalleCodigo" name="detalleCodigo" class="form-control" placeholder="Ingrese el código de acceso">
                        </div>
                        <div id="detalleMarbeteContainer" style="display: none; margin-top: 10px;">
                            <label for="detalleMarbete">Número de marbete:</label>
                            <input type="text" id="detalleMarbete" name="detalleMarbete" class="form-control" placeholder="Ingrese el número de marbete">
                        </div>
                        <div id="detalleEntradaLibreContainer" style="display: none; margin-top: 10px;">
                            <label for="detalleEntradaLibre">Detalles de entrada libre:</label>
                            <input type="text" id="detalleEntradaLibre" name="detalleEntradaLibre" class="form-control" placeholder="Ingrese detalles adicionales (opcional)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 3: Información de Inquilinos -->
            <div class="form-step" data-step="3">
                <h2 class="step-title">
                    <span>🏠</span> En Caso el Inmueble Esté Ocupado por Inquilinos
                </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>¿Tiene Contrato de Arrendamiento?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="contratoSi" name="contratoArrendamiento" value="Si">
                                <label for="contratoSi">Sí</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="contratoNo" name="contratoArrendamiento" value="No">
                                <label for="contratoNo">No</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="aPagarRenta">¿A Quién le Paga la Renta?</label>
                        <input type="text" id="aPagarRenta" name="aPagarRenta" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="valorRenta">Valor de la Renta</label>
                        <input type="number" id="valorRenta" name="valorRenta" min="0" step="0.01" placeholder="Q 0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="tiempoResidenciaInquilino">Tiempo de Residir en el Inmueble (Inquilino)</label>
                        <input type="text" id="tiempoResidenciaInquilino" name="tiempoResidenciaInquilino" placeholder="Ej: 2 años, 6 meses">
                    </div>
                    
                    <div class="form-group">
                        <label for="formaPago">Forma de Pago</label>
                        <select id="formaPago" name="formaPago">
                            <option value="">Seleccione...</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="comentariosInquilino">Comentarios</label>
                        <textarea id="comentariosInquilino" name="comentariosInquilino" rows="3" placeholder="Comentarios adicionales sobre el arrendamiento"></textarea>
                    </div>
                </div>
            </div>

            <!-- Paso 4: Información del Negocio Propio -->
            <div class="form-step" data-step="4">
                <h2 class="step-title">
                    <span>💼</span> Negocio Propio
                </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombreNegocio">Nombre del Negocio</label>
                        <input type="text" id="nombreNegocio" name="nombreNegocio" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="patenteComercio">Patente de Comercio</label>
                        <input type="text" id="patenteComercio" name="patenteComercio" maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="giroNegocio">Giro del Negocio</label>
                        <input type="text" id="giroNegocio" name="giroNegocio" maxlength="100" placeholder="Ej: Venta de abarrotes, Panadería, etc.">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="direccionNegocio">Dirección del Negocio</label>
                        <textarea id="direccionNegocio" name="direccionNegocio" rows="2" placeholder="Dirección completa del negocio"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Local</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="localPropio" name="tipoLocal" value="Propio">
                                <label for="localPropio">Propio</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="localFamiliar" name="tipoLocal" value="Familiar">
                                <label for="localFamiliar">Familiar</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="localAmortizado" name="tipoLocal" value="Amortizado">
                                <label for="localAmortizado">Amortizado</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="localAlquilado" name="tipoLocal" value="Alquilada">
                                <label for="localAlquilado">Alquilado</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pagoMensualLocal">Pago Mensual del Local</label>
                        <input type="number" id="pagoMensualLocal" name="pagoMensualLocal" min="0" step="0.01" placeholder="Q 0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="tiempoOperacion">Tiempo de Operación</label>
                        <input type="text" id="tiempoOperacion" name="tiempoOperacion" placeholder="Ej: 3 años, 8 meses">
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroEmpleados">No. Empleados</label>
                        <input type="number" id="numeroEmpleados" name="numeroEmpleados" min="0" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="ingresosMensuales">Ingresos Mensuales</label>
                        <input type="number" id="ingresosMensuales" name="ingresosMensuales" min="0" step="0.01" placeholder="Q 0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="pagoMensualNegocio">Pago Mensual (Gastos)</label>
                        <input type="number" id="pagoMensualNegocio" name="pagoMensualNegocio" min="0" step="0.01" placeholder="Q 0.00">
                    </div>

                    <!-- Proveedores -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Proveedores Principales</h4>
                        <div id="proveedoresContainer">
                            <div class="proveedor-item dynamic-item">
                                <div class="form-grid two-columns">
                                    <input type="text" name="proveedor[]" placeholder="Nombre del proveedor" maxlength="100">
                                    <input type="number" name="montoProveedor[]" placeholder="Monto Q" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarProveedor()">+ Agregar Proveedor</button>
                    </div>

                    <!-- Mobiliario y Equipo -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Mobiliario y Equipo</h4>
                        <div id="mobiliarioContainer">
                            <div class="mobiliario-item dynamic-item">
                                <div class="form-grid two-columns">
                                    <input type="text" name="mobiliario[]" placeholder="Descripción" maxlength="100">
                                    <input type="number" name="valorMobiliario[]" placeholder="Valor Q" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarMobiliario()">+ Agregar Mobiliario</button>
                    </div>

                    <!-- Mercadería en Negocio -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Mercadería en Negocio</h4>
                        <div id="mercaderiaContainer">
                            <div class="mercaderia-item dynamic-item">
                                <div class="form-grid two-columns">
                                    <input type="text" name="mercaderia[]" placeholder="Descripción" maxlength="100">
                                    <input type="number" name="valorMercaderia[]" placeholder="Valor Q" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarMercaderia()">+ Agregar Mercadería</button>
                    </div>

                    <!-- Estado Físico del Negocio -->
                    <div class="form-group">
                        <label>Estado Físico Interior del Negocio</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="interiorBueno" name="estadoFisicoInterior" value="Bueno">
                                <label for="interiorBueno">Bueno</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="interiorRegular" name="estadoFisicoInterior" value="Regular">
                                <label for="interiorRegular">Regular</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="interiorMalo" name="estadoFisicoInterior" value="Malo">
                                <label for="interiorMalo">Malo</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado Físico Exterior del Negocio</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="exteriorBueno" name="estadoFisicoExterior" value="Bueno">
                                <label for="exteriorBueno">Bueno</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="exteriorRegular" name="estadoFisicoExterior" value="Regular">
                                <label for="exteriorRegular">Regular</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="exteriorMalo" name="estadoFisicoExterior" value="Malo">
                                <label for="exteriorMalo">Malo</label>
                            </div>
                        </div>
                    </div>

                    <!-- Inventario -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Inventario</h4>
                        <div class="inventario-header">
                            <div>Descripción</div>
                            <div>Cantidad</div>
                            <div>Compra Q</div>
                            <div>Venta Q</div>
                            <div>Total Q</div>
                            <div></div>
                        </div>
                        <div id="inventarioContainer">
                            <div class="inventario-item dynamic-item">
                                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                                    <input type="text" name="productoDescripcion[]" placeholder="Descripción del Producto" maxlength="100">
                                    <input type="number" name="productoCantidad[]" placeholder="Cantidad" min="0" onchange="calcularTotalVenta(this)">
                                    <input type="number" name="productoCompra[]" placeholder="Valor Compra Q" min="0" step="0.01">
                                    <input type="number" name="productoVenta[]" placeholder="Precio Venta Q" min="0" step="0.01" onchange="calcularTotalVenta(this)">
                                    <input type="number" name="productoTotalVenta[]" placeholder="Total Venta Q" readonly>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarInventario()">+ Agregar Producto</button>
                    </div>

                    <!-- Costos Fijos -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Costos Fijos</h4>
                        <div class="form-grid two-columns">
                            <div class="form-group">
                                <label for="costoAgua">Agua</label>
                                <input type="number" id="costoAgua" name="costoAgua" min="0" step="0.01" placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="costoLuz">Luz</label>
                                <input type="number" id="costoLuz" name="costoLuz" min="0" step="0.01" placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="costoAlquiler">Alquiler</label>
                                <input type="number" id="costoAlquiler" name="costoAlquiler" min="0" step="0.01" placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="costoTelefono">Teléfono</label>
                                <input type="number" id="costoTelefono" name="costoTelefono" min="0" step="0.01" placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="costoBasura">Basura</label>
                                <input type="number" id="costoBasura" name="costoBasura" min="0" step="0.01" placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="totalCostosFijos">Total Costos Fijos</label>
                                <input type="number" id="totalCostosFijos" name="totalCostosFijos" readonly placeholder="Q 0.00">
                            </div>
                        </div>
                    </div>

                    <!-- Otros Gastos -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Otros Gastos</h4>
                        <div id="otrosGastosContainer">
                            <div class="otros-gastos-item dynamic-item">
                                <div class="form-grid two-columns">
                                    <input type="text" name="descripcionGasto[]" placeholder="Descripción" maxlength="100">
                                    <input type="number" name="montoGasto[]" placeholder="Monto Q" min="0" step="0.01" onchange="calcularTotalCostos()">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarOtrosGastos()">+ Agregar Gasto</button>
                    </div>

                    <!-- Resumen Financiero -->
                    <div class="form-group full-width dynamic-section">
                        <h4>Resumen Financiero</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="totalVentasMes">Total Ventas en el Mes</label>
                                <input type="number" id="totalVentasMes" name="totalVentasMes" readonly placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="costoTotalMes">Costo Total en el Mes</label>
                                <input type="number" id="costoTotalMes" name="costoTotalMes" readonly placeholder="Q 0.00">
                            </div>
                            <div class="form-group">
                                <label for="utilidadNeta">Utilidad Neta del Negocio</label>
                                <input type="number" id="utilidadNeta" name="utilidadNeta" readonly placeholder="Q 0.00">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 5: Relación de Dependencia -->
            <div class="form-step" data-step="5">
                <h2 class="step-title">
                    <span>🏢</span> Relación de Dependencia
                </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombreEmpresa">Nombre de la Empresa</label>
                        <input type="text" id="nombreEmpresa" name="nombreEmpresa" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="direccionEmpresa">Dirección de la Empresa</label>
                        <input type="text" id="direccionEmpresa" name="direccionEmpresa" maxlength="200">
                    </div>
                    
                    <div class="form-group">
                        <label>¿Tiene IGSS?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="igssSi" name="igss" value="Si">
                                <label for="igssSi">Sí</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="igssNo" name="igss" value="No">
                                <label for="igssNo">No</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="puestoTrabajo">Puesto</label>
                        <input type="text" id="puestoTrabajo" name="puestoTrabajo" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="salario">Salario</label>
                        <input type="number" id="salario" name="salario" min="0" step="0.01" placeholder="Q 0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaIngreso">Fecha de Ingreso</label>
                        <input type="text" id="fechaIngreso" name="fechaIngreso" placeholder="Ej: Enero 2020, 01/2020, Hace 3 años, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="telefonoEmpresa">Teléfono de la Empresa</label>
                        <input type="tel" id="telefonoEmpresa" name="telefonoEmpresa" pattern="[0-9\-\+\s\(\)]{8,15}">
                    </div>
                </div>
            </div>

            <!-- Paso 6: Verificación con Vecinos y Observaciones -->
            <div class="form-step" data-step="6">
                <h2 class="step-title">
                    <span>🏘️</span> Verificación con Vecinos y Observaciones
                </h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="verificacionCasa1">Verificación Casa 1</label>
                        <textarea id="verificacionCasa1" name="verificacionCasa1" rows="3" placeholder="Información proporcionada por el vecino de la casa 1"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="verificacionCasa2">Verificación Casa 2</label>
                        <textarea id="verificacionCasa2" name="verificacionCasa2" rows="3" placeholder="Información proporcionada por el vecino de la casa 2"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="observacionesGenerales">Observaciones Generales</label>
                        <textarea id="observacionesGenerales" name="observacionesGenerales" rows="5" placeholder="Ingrese cualquier observación relevante sobre la visita..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Fotografías de la Vivienda y Negocio</label>
                        <div class="photo-buttons">
                            <input type="file" id="photos-camera" name="photos" accept="image/*" multiple capture="environment" class="file-input" style="display: none;">
                            <input type="file" id="photos-gallery" name="photos" accept="image/*" multiple class="file-input" style="display: none;">
                            
                            <button type="button" class="photo-btn camera-btn" onclick="document.getElementById('photos-camera').click()">
                                <span>📷</span>
                                <div>
                                    <strong>Tomar Foto</strong><br>
                                    <small>Usar cámara</small>
                                </div>
                            </button>
                            
                            <button type="button" class="photo-btn gallery-btn" onclick="document.getElementById('photos-gallery').click()">
                                <span>🖼️</span>
                                <div>
                                    <strong>Galería</strong><br>
                                    <small>Seleccionar fotos</small>
                                </div>
                            </button>
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="verificador">Nombre del Verificador <span class="required">*</span></label>
                        <select id="verificador" name="verificador" required>
                            <option value="">Seleccione un verificador</option>
                            <option value="Juan Morales">Juan Morales</option>
                            <option value="Walter Cruz">Walter Cruz</option>
                            <option value="Mario Pineda">Mario Pineda</option>
                            <option value="Miguel Samayoa">Miguel Samayoa</option>
                            <option value="Alejandro Mun">Alejandro Mun</option>
                            <option value="Nehemias Ramos">Nehemias Ramos</option>
                            <option value="Amilcar Hernandez">Amilcar Hernandez</option>
                            <option value="Oscar Cotero">Oscar Cotero</option>
                            <option value="Juan Pablo Tomin">Juan Pablo Tomin</option>
                            <option value="Estuardo Hernandez">Estuardo Hernandez</option>
                            <option value="Luis Fernando Duarte">Luis Fernando Duarte</option>
                            <option value="Henry Pacay">Henry Pacay</option>
                            <option value="Hugo López">Hugo López</option>
                            <option value="Luis Ordoñez">Luis Ordoñez</option>
                            <option value="Eswin Gonzalez">Eswin Gonzalez</option>
                            <option value="Deybi Jimenez">Deybi Jimenez</option>
                        </select>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                </div>
            </div>

            <!-- Paso 7: Croquis -->
            <div class="form-step" data-step="7">
                <h2 class="step-title">
                    <span>🗺️</span> Croquis de Vivienda y Ubicación
                </h2>
                <div class="canvas-container">
                    <h3>Croquis de la Vivienda</h3>
                    <p>Dibuje un croquis de la vivienda y sus alrededores</p>
                    <canvas id="sketchCanvas" width="400" height="300"></canvas>
                    <div class="form-group full-width" style="margin-top: 16px;">
                        <label for="croquisViviendaObservaciones">Observaciones del Croquis de Vivienda</label>
                        <textarea id="croquisViviendaObservaciones" name="croquisViviendaObservaciones" rows="2" placeholder="Describa puntos de referencia, colores, etc."></textarea>
                    </div>
                    <div class="canvas-tools">
                        <button type="button" class="tool-btn active" data-tool="draw">
                            <span>✏️</span> Dibujar
                        </button>
                        <button type="button" class="tool-btn" data-thickness="2">
                            <span>⚫</span> Fino
                        </button>
                        <button type="button" class="tool-btn" data-thickness="5">
                            <span>⬤</span> Grueso
                        </button>
                        <button type="button" class="tool-btn" id="undoBtn">
                            <span>↶</span> Deshacer
                        </button>
                        <button type="button" class="tool-btn" id="clearSketchBtn">
                            <span>🗑️</span> Limpiar
                        </button>
                    </div>
                </div>
                
                <div class="canvas-container" style="margin-top: 24px;">
                    <h3>Croquis de Ubicación</h3>
                    <p>Dibuje un croquis de la ubicación del inmueble o use su ubicación actual</p>
                    
                    <!-- Botón para obtener ubicación actual -->
                    <div style="margin-bottom: 16px;">
                        <button type="button" class="btn-secondary" id="btnObtenerUbicacion" onclick="obtenerUbicacionActual()">
                            <span>📍</span> Obtener Ubicación Actual
                        </button>
                        <span id="ubicacionStatus" style="margin-left: 10px; font-size: 14px; color: #666;"></span>
                    </div>
                    
                    <!-- Mapa de previsualización -->
                    <div id="mapaUbicacionContainer" style="display: none; margin-bottom: 16px;">
                        <iframe 
                            id="mapaUbicacion" 
                            width="100%" 
                            height="300" 
                            style="border: 2px solid var(--primary-color); border-radius: var(--border-radius);"
                            frameborder="0">
                        </iframe>
                        <div style="margin-top: 8px; font-size: 13px; color: #666;">
                            <strong>Coordenadas:</strong> 
                            <span id="coordenadasTexto"></span>
                        </div>
                    </div>
                    
                    <canvas id="locationCanvas" width="400" height="300"></canvas>
                    <div class="form-group full-width" style="margin-top: 16px;">
                        <label for="croquisUbicacionObservaciones">Observaciones del Croquis de Ubicación</label>
                        <textarea id="croquisUbicacionObservaciones" name="croquisUbicacionObservaciones" rows="2" placeholder="Indique calles, avenidas, y puntos clave."></textarea>
                    </div>
                    <div class="canvas-tools">
                        <button type="button" class="tool-btn active" data-tool="draw" data-canvas="location">
                            <span>✏️</span> Dibujar
                        </button>
                        <button type="button" class="tool-btn" data-thickness="2" data-canvas="location">
                            <span>⚫</span> Fino
                        </button>
                        <button type="button" class="tool-btn" data-thickness="5" data-canvas="location">
                            <span>⬤</span> Grueso
                        </button>
                        <button type="button" class="tool-btn" id="undoLocationBtn">
                            <span>↶</span> Deshacer
                        </button>
                        <button type="button" class="tool-btn" id="clearLocationBtn">
                            <span>🗑️</span> Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Firmas del Cliente y Verificador (debajo del mapa) -->
                <div class="canvas-container" style="margin-top: 32px;">
                    <h3>✍️ Autorización del Cliente</h3>
                    
                    <!-- Tipo de autorización -->
                    <div class="form-group" style="margin-bottom: 16px; text-align: left;">
                        <label style="font-weight: bold; margin-bottom: 8px; display: block;">Tipo de Autorización <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="tipoFirma" name="tipoAutorizacion" value="Firma" checked onchange="toggleAutorizacion()">
                                <label for="tipoFirma">✍️ Firma</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="tipoHuella" name="tipoAutorizacion" value="Huella Dactilar" onchange="toggleAutorizacion()">
                                <label for="tipoHuella">👆 Huella Dactilar</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="tipoNoAutorizo" name="tipoAutorizacion" value="No Autorizó" onchange="toggleAutorizacion()">
                                <label for="tipoNoAutorizo">❌ No Autorizó</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Canvas de firma (se muestra según el tipo) -->
                    <div id="canvasAutorizacionContainer">
                        <p id="instruccionAutorizacion">El cliente debe firmar aquí para confirmar la información</p>
                        
                        <!-- Botón para tomar foto de huella (solo visible cuando se selecciona Huella) -->
                        <div id="btnTomarHuellaContainer" style="display: none; margin-bottom: 12px;">
                            <input type="file" id="huellaFileInput" accept="image/*" capture="environment" style="display: none;" onchange="cargarImagenHuella(event)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('huellaFileInput').click()">
                                <span>📸</span> Tomar Foto de Huella
                            </button>
                            <button type="button" class="btn-secondary" onclick="document.getElementById('huellaFileInputGaleria').click()" style="margin-left: 8px;">
                                <span>🖼️</span> Desde Galería
                            </button>
                            <input type="file" id="huellaFileInputGaleria" accept="image/*" style="display: none;" onchange="cargarImagenHuella(event)">
                        </div>
                        
                        <canvas id="signatureCanvas" width="400" height="200"></canvas>
                        <div class="canvas-tools">
                            <button type="button" class="tool-btn" id="mejorarHuellaBtn" onclick="mejorarHuella()" style="display: none;">
                                <span>✨</span> Mejorar Contraste
                            </button>
                            <button type="button" class="tool-btn" id="clearSignatureBtn">
                                <span>🗑️</span> Limpiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Campo para motivo si no autorizó -->
                    <div id="motivoNoAutorizacion" style="display: none; margin-top: 16px;">
                        <label for="motivoNoAutorizo" style="font-weight: bold;">Motivo por el que no autorizó:</label>
                        <textarea id="motivoNoAutorizo" name="motivoNoAutorizo" rows="2" placeholder="Indique el motivo..."></textarea>
                    </div>
                    
                    <div class="error-message" id="signatureError">La autorización es obligatoria</div>
                </div>
                
                <div class="canvas-container" style="margin-top: 24px;">
                    <h3>✍️ Firma del Verificador</h3>
                    <p>El verificador debe firmar aquí <span class="required">*</span></p>
                    <canvas id="verifierSignatureCanvas" width="400" height="200"></canvas>
                    <div class="canvas-tools">
                        <button type="button" class="tool-btn" id="clearVerifierSignatureBtn">
                            <span>🗑️</span> Limpiar Firma
                        </button>
                    </div>
                    <div class="error-message" id="verifierSignatureError">La firma del verificador es obligatoria</div>
                </div>
            </div>

            <!-- Paso 8: Finalización -->
            <div class="form-step" data-step="8">
                <h2 class="step-title">
                    <span>✅</span> Finalización
                </h2>
                
                <div class="success-message" id="successMessage">
                    <strong>¡Formulario completado exitosamente!</strong><br>
                    Los datos han sido guardados correctamente.
                </div>
            </div>
            <div class="form-step" data-step="4">
                <h2 class="step-title">
                    <span>📝</span> Observaciones y Adjuntos
                </h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="observaciones">Observaciones Generales</label>
                        <textarea id="observaciones" name="observaciones" rows="5" placeholder="Ingrese cualquier observación relevante sobre la visita..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="recomendaciones">Recomendaciones</label>
                        <textarea id="recomendaciones" name="recomendaciones" rows="4" placeholder="Ingrese recomendaciones para el solicitante..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Fotografías de la Vivienda</label>
                        <div class="photo-buttons">
                            <input type="file" id="photos2-camera" name="photos" accept="image/*" multiple capture="environment" class="file-input" style="display: none;">
                            <input type="file" id="photos2-gallery" name="photos" accept="image/*" multiple class="file-input" style="display: none;">
                            
                            <button type="button" class="photo-btn camera-btn" onclick="document.getElementById('photos2-camera').click()">
                                <span>📷</span>
                                <div>
                                    <strong>Tomar Foto</strong><br>
                                    <small>Usar cámara</small>
                                </div>
                            </button>
                            
                            <button type="button" class="photo-btn gallery-btn" onclick="document.getElementById('photos2-gallery').click()">
                                <span>🖼️</span>
                                <div>
                                    <strong>Galería</strong><br>
                                    <small>Seleccionar fotos</small>
                                </div>
                            </button>
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaVisita">Fecha de la Visita <span class="required">*</span></label>
                        <input type="date" id="fechaVisita" name="fechaVisita" required>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="verificador">Nombre del Verificador <span class="required">*</span></label>
                        <select id="verificador" name="verificador" required>
                            <option value="">Seleccione un verificador</option>
                            <option value="Juan Morales">Juan Morales</option>
                            <option value="Walter Cruz">Walter Cruz</option>
                            <option value="Mario Pineda">Mario Pineda</option>
                            <option value="Miguel Samayoa">Miguel Samayoa</option>
                            <option value="Alejandro Mun">Alejandro Mun</option>
                            <option value="Nehemias Ramos">Nehemias Ramos</option>
                            <option value="Amilcar Hernandez">Amilcar Hernandez</option>
                            <option value="Oscar Cotero">Oscar Cotero</option>
                            <option value="Juan Pablo Tomin">Juan Pablo Tomin</option>
                            <option value="Estuardo Hernandez">Estuardo Hernandez</option>
                            <option value="Luis Fernando Duarte">Luis Fernando Duarte</option>
                            <option value="Henry Pacay">Henry Pacay</option>
                            <option value="Hugo López">Hugo López</option>
                            <option value="Luis Ordoñez">Luis Ordoñez</option>
                            <option value="Eswin Gonzalez">Eswin Gonzalez</option>
                            <option value="Deybi Jimenez">Deybi Jimenez</option>
                        </select>
                        <div class="error-message">Este campo es obligatorio</div>
                    </div>
                </div>
            </div>

            <!-- Paso 5: Croquis -->
            <div class="form-step" data-step="5">
                <h2 class="step-title">
                    <span>🗺️</span> Croquis de la Vivienda
                </h2>
                <div class="canvas-container">
                    <p>Dibuje un croquis de la vivienda y sus alrededores</p>
                    <canvas id="sketchCanvas" width="400" height="300"></canvas>
                    <div class="canvas-tools">
                        <button type="button" class="tool-btn active" data-tool="draw">
                            <span>✏️</span> Dibujar
                        </button>
                        <button type="button" class="tool-btn" data-thickness="2">
                            <span>⚫</span> Fino
                        </button>
                        <button type="button" class="tool-btn" data-thickness="5">
                            <span>⬤</span> Grueso
                        </button>
                        <button type="button" class="tool-btn" id="undoBtn">
                            <span>↶</span> Deshacer
                        </button>
                        <button type="button" class="tool-btn" id="clearSketchBtn">
                            <span>🗑️</span> Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paso 6: Firma -->
            <div class="form-step" data-step="6">
                <h2 class="step-title">
                    <span>✍️</span> Firma del Solicitante
                </h2>
                <div class="canvas-container">
                    <p>El solicitante debe firmar aquí para confirmar la información <span class="required">*</span></p>
                    <canvas id="signatureCanvas" width="400" height="200"></canvas>
                    <div class="canvas-tools">
                        <button type="button" class="tool-btn" id="clearSignatureBtn">
                            <span>🗑️</span> Limpiar Firma
                        </button>
                    </div>
                    <div class="error-message" id="signatureError">La firma es obligatoria</div>
                </div>
                
                <div class="success-message" id="successMessage">
                    <strong>¡Formulario completado exitosamente!</strong><br>
                    Los datos han sido guardados correctamente.
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                    <span>←</span> Anterior
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn">
                    Siguiente <span>→</span>
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                    <span>✓</span> Enviar Formulario
                </button>
                <button type="button" class="btn btn-success" id="pdfBtn" style="display: none;" onclick="generarPDFConMapa()">
                    <span>📄</span> Descargar PDF
                </button>
            </div>
        </form>
    </div>

    <div class="auto-save" id="autoSave">
        Guardado automáticamente
    </div>
    </div>
    <!-- Fin del formulario-container -->

    <script>
        // Variable global para almacenar la empresa seleccionada
        let empresaSeleccionada = '';

        // Función para seleccionar la empresa
        function seleccionarEmpresa(empresa) {
            empresaSeleccionada = empresa;
            
            // Ocultar el selector de empresa
            document.getElementById('empresaSelector').style.display = 'none';
            
            // Mostrar el formulario
            document.getElementById('formularioContainer').classList.add('active');
            
            // Aplicar los colores según la empresa
            if (empresa === 'coop') {
                document.body.classList.add('coopexpress');
                document.querySelector('.header h1').textContent = '📋 Formulario de Visitas - Coopexpress';
            } else {
                document.body.classList.remove('coopexpress');
                document.querySelector('.header h1').textContent = '📋 Formulario de Visitas - Presta Express';
            }
            
            console.log('Empresa seleccionada:', empresa);
        }
    </script>

    <script>
        function mostrarOtroDestino() {
            const destinoCredito = document.getElementById('destinoCredito');
            const otroDestinoContainer = document.getElementById('otroDestinoContainer');
            const otroDestino = document.getElementById('otroDestino');
            
            if (destinoCredito.value === 'Otro') {
                otroDestinoContainer.style.display = 'block';
                otroDestino.required = true;
            } else {
                otroDestinoContainer.style.display = 'none';
                otroDestino.required = false;
                otroDestino.value = '';
            }
        }

        function mostrarDetalleGarita() {
            const formaIngreso = document.getElementById('formaIngresoGarita');
            const detalleCodigoContainer = document.getElementById('detalleCodigoContainer');
            const detalleMarbeteContainer = document.getElementById('detalleMarbeteContainer');
            const detalleEntradaLibreContainer = document.getElementById('detalleEntradaLibreContainer');
            const detalleCodigo = document.getElementById('detalleCodigo');
            const detalleMarbete = document.getElementById('detalleMarbete');
            const detalleEntradaLibre = document.getElementById('detalleEntradaLibre');
            
            // Ocultar todos los campos primero
            detalleCodigoContainer.style.display = 'none';
            detalleMarbeteContainer.style.display = 'none';
            detalleEntradaLibreContainer.style.display = 'none';
            detalleCodigo.required = false;
            detalleMarbete.required = false;
            detalleEntradaLibre.required = false;
            
            // Mostrar el campo correspondiente según la selección
            if (formaIngreso.value === 'Código') {
                detalleCodigoContainer.style.display = 'block';
                detalleCodigo.required = true;
            } else if (formaIngreso.value === 'Marbete') {
                detalleMarbeteContainer.style.display = 'block';
                detalleMarbete.required = true;
            } else if (formaIngreso.value === 'Entrada Libre') {
                detalleEntradaLibreContainer.style.display = 'block';
                // Entrada Libre no es requerido, es opcional
            }
        }

        // Variables globales para la ubicación
        let ubicacionActual = null;

        async function cargarImagenMapaEstatico(lat, lng) {
            if (!ubicacionActual) return;
            
            console.log('Cargando mapa satelital de Google Maps...');
            
            const status = document.getElementById('ubicacionStatus');
            if (status) {
                status.textContent = '⏳ Cargando mapa satelital...';
                status.style.color = '#ff6500';
            }
            
            // Usar Google Maps Static API
            const googleApiKey = 'AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8';
            const mapaUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=18&size=800x500&maptype=satellite&markers=color:red%7Clabel:📍%7C${lat},${lng}&key=${googleApiKey}`;
            
            console.log('URL del mapa:', mapaUrl);
            
            // Crear una imagen y cargarla
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                console.log('✅ Imagen del mapa cargada');
                
                // Crear canvas y dibujar la imagen
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 500;
                const ctx = canvas.getContext('2d');
                
                try {
                    ctx.drawImage(img, 0, 0, 800, 500);
                    ubicacionActual.mapaImagen = canvas.toDataURL('image/jpeg', 0.95);
                    console.log('✅ Mapa convertido a base64 exitosamente');
                    
                    if (status) {
                        status.textContent = '✅ Ubicación y mapa satelital listos';
                        status.style.color = '#2e7d32';
                    }
                } catch (error) {
                    console.error('Error al convertir mapa:', error);
                    // Intentar sin canvas, guardando la URL directamente
                    ubicacionActual.mapaImagenDirecta = mapaUrl;
                    if (status) {
                        status.textContent = '✅ Ubicación GPS lista';
                        status.style.color = '#2e7d32';
                    }
                }
            };
            
            img.onerror = function(error) {
                console.error('Error al cargar mapa de Google:', error);
                console.log('Intentando método alternativo...');
                
                // Método alternativo: crear una imagen sin CORS
                const imgSinCors = document.createElement('img');
                imgSinCors.src = mapaUrl;
                
                imgSinCors.onload = function() {
                    // Guardar la URL para usarla directamente
                    ubicacionActual.mapaImagenDirecta = mapaUrl;
                    console.log('✅ URL del mapa guardada');
                    
                    if (status) {
                        status.textContent = '✅ Ubicación GPS lista';
                        status.style.color = '#2e7d32';
                    }
                };
                
                imgSinCors.onerror = function() {
                    console.error('Error total al cargar el mapa');
                    if (status) {
                        status.textContent = '⚠️ Ubicación GPS lista (mapa no disponible)';
                        status.style.color = '#ff6500';
                    }
                };
            };
            
            img.src = mapaUrl;
        }
        
        function generarMapaPlaceholder(canvas, ctx, lat, lng) {
            // Fondo blanco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Borde naranja
            ctx.strokeStyle = '#FF6500';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Título
            ctx.fillStyle = '#FF6500';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('📍 UBICACIÓN GPS', canvas.width / 2, 60);
            
            // Marcador grande en el centro
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Círculo del marcador
            ctx.beginPath();
            ctx.arc(centerX, centerY, 60, 0, 2 * Math.PI);
            ctx.fillStyle = '#FF0000';
            ctx.fill();
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 8;
            ctx.stroke();
            
            // Punto blanco en el centro
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();
            
            // Coordenadas
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('COORDENADAS:', canvas.width / 2, canvas.height - 150);
            
            ctx.font = '24px Arial';
            ctx.fillText(`Latitud: ${lat.toFixed(6)}`, canvas.width / 2, canvas.height - 110);
            ctx.fillText(`Longitud: ${lng.toFixed(6)}`, canvas.width / 2, canvas.height - 70);
            
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666666';
            ctx.fillText(`Precisión: ${ubicacionActual.precision.toFixed(0)} metros`, canvas.width / 2, canvas.height - 30);
            
            ubicacionActual.mapaImagen = canvas.toDataURL('image/png');
            console.log('✅ Placeholder del mapa generado');
            
            // Actualizar el status
            const status = document.getElementById('ubicacionStatus');
            if (status) {
                status.textContent = '✅ Ubicación lista (mapa no disponible)';
                status.style.color = '#2e7d32';
            }
        }

        // Función para manejar el tipo de autorización del cliente
        function toggleAutorizacion() {
            const tipoAutorizacion = document.querySelector('input[name="tipoAutorizacion"]:checked').value;
            const canvasContainer = document.getElementById('canvasAutorizacionContainer');
            const motivoContainer = document.getElementById('motivoNoAutorizacion');
            const instruccion = document.getElementById('instruccionAutorizacion');
            const btnTomarHuellaContainer = document.getElementById('btnTomarHuellaContainer');
            const btnMejorarHuella = document.getElementById('mejorarHuellaBtn');
            const signatureCanvas = document.getElementById('signatureCanvas');
            const ctx = signatureCanvas.getContext('2d');
            
            // Limpiar canvas
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            
            if (tipoAutorizacion === 'Firma') {
                canvasContainer.style.display = 'block';
                motivoContainer.style.display = 'none';
                btnTomarHuellaContainer.style.display = 'none';
                btnMejorarHuella.style.display = 'none';
                instruccion.textContent = 'El cliente debe firmar aquí para confirmar la información';
            } else if (tipoAutorizacion === 'Huella Dactilar') {
                canvasContainer.style.display = 'block';
                motivoContainer.style.display = 'none';
                btnTomarHuellaContainer.style.display = 'block';
                btnMejorarHuella.style.display = 'inline-block';
                instruccion.textContent = '👆 Tome una foto de la huella dactilar del cliente con el botón de abajo, o dibújela manualmente';
            } else if (tipoAutorizacion === 'No Autorizó') {
                canvasContainer.style.display = 'none';
                motivoContainer.style.display = 'block';
                btnTomarHuellaContainer.style.display = 'none';
                btnMejorarHuella.style.display = 'none';
            }
        }
        
        // Función para mejorar el contraste de la huella aún más
        function mejorarHuella() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Aplicar umbral para hacer blanco y negro puro (como huella escaneada)
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // Umbral: si es más claro que 128, hazlo blanco; si no, negro
                const threshold = 140; // Puedes ajustar este valor
                const value = gray > threshold ? 255 : 0;
                
                data[i] = value;     // R
                data[i + 1] = value; // G
                data[i + 2] = value; // B
            }
            
            ctx.putImageData(imageData, 0, 0);
            console.log('✨ Contraste de huella mejorado al máximo');
        }
        
        // Función para cargar imagen de huella desde la cámara o galería
        function cargarImagenHuella(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('signatureCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Limpiar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Calcular dimensiones para mantener aspecto y ajustar al canvas
                    const canvasAspect = canvas.width / canvas.height;
                    const imgAspect = img.width / img.height;
                    
                    let drawWidth, drawHeight, offsetX, offsetY;
                    
                    if (imgAspect > canvasAspect) {
                        // Imagen más ancha que el canvas
                        drawWidth = canvas.width;
                        drawHeight = canvas.width / imgAspect;
                        offsetX = 0;
                        offsetY = (canvas.height - drawHeight) / 2;
                    } else {
                        // Imagen más alta que el canvas
                        drawHeight = canvas.height;
                        drawWidth = canvas.height * imgAspect;
                        offsetX = (canvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    
                    // Dibujar imagen centrada en el canvas
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    
                    // APLICAR FILTROS PARA MEJORAR LA HUELLA
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Convertir a escala de grises y aumentar contraste
                    for (let i = 0; i < data.length; i += 4) {
                        // Convertir a escala de grises
                        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        
                        // Aumentar contraste (hacer más blanco o más negro)
                        const contrast = 1.5; // Factor de contraste
                        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                        let adjusted = factor * (gray - 128) + 128;
                        
                        // Umbral para hacer más definido (opcional)
                        // adjusted = adjusted > 128 ? 255 : 0; // Descomenta para efecto más fuerte
                        
                        // Limitar valores
                        adjusted = Math.max(0, Math.min(255, adjusted));
                        
                        data[i] = adjusted;     // R
                        data[i + 1] = adjusted; // G
                        data[i + 2] = adjusted; // B
                        // data[i + 3] se mantiene (alpha)
                    }
                    
                    // Aplicar la imagen procesada
                    ctx.putImageData(imageData, 0, 0);
                    
                    console.log('✅ Imagen de huella cargada y optimizada');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Variable para almacenar múltiples lecturas de GPS
        let lecturasGPS = [];
        let watchId = null;
        let timeoutId = null;
        let mejorLectura = null;
        
        function obtenerUbicacionActual() {
            const btn = document.getElementById('btnObtenerUbicacion');
            const status = document.getElementById('ubicacionStatus');
            const mapaContainer = document.getElementById('mapaUbicacionContainer');
            
            if (!navigator.geolocation) {
                status.textContent = '❌ La geolocalización no está disponible en este navegador';
                status.style.color = '#d32f2f';
                return;
            }
            
            // Limpiar cualquier watch anterior
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            
            // Reiniciar variables
            lecturasGPS = [];
            mejorLectura = null;
            let lecturasRealizadas = 0;
            const maxLecturas = 6; // Máximo 6 lecturas
            const tiempoMaximo = 8000; // 8 segundos máximo
            
            // Mostrar estado de carga
            btn.disabled = true;
            btn.innerHTML = '<span>⏳</span> Obteniendo ubicación precisa...';
            status.textContent = '🎯 Calibrando GPS de alta precisión...';
            status.style.color = '#ff6500';
            
            const tiempoInicio = Date.now();
            
            // Usar watchPosition directamente para obtener múltiples lecturas continuas
            watchId = navigator.geolocation.watchPosition(
                function(position) {
                    lecturasRealizadas++;
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const tiempoTranscurrido = ((Date.now() - tiempoInicio) / 1000).toFixed(1);
                    
                    console.log(`📍 Lectura ${lecturasRealizadas}: ${accuracy.toFixed(1)}m (${tiempoTranscurrido}s)`);
                    
                    // Agregar lectura si tiene precisión aceptable (< 200m)
                    if (accuracy < 200) {
                        const lectura = {
                            lat: lat,
                            lng: lng,
                            accuracy: accuracy,
                            altitude: position.coords.altitude,
                            altitudeAccuracy: position.coords.altitudeAccuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            timestamp: Date.now()
                        };
                        
                        lecturasGPS.push(lectura);
                        
                        // Actualizar mejor lectura
                        if (!mejorLectura || accuracy < mejorLectura.accuracy) {
                            mejorLectura = lectura;
                            console.log(`✨ Nueva mejor precisión: ${accuracy.toFixed(1)}m`);
                        }
                        
                        // Mostrar progreso
                        status.textContent = `🎯 ${lecturasGPS.length} lecturas - Mejor: ${mejorLectura.accuracy.toFixed(1)}m`;
                        
                        // Condiciones para finalizar RÁPIDO:
                        // 1. Precisión perfecta (< 8m) con 2+ lecturas
                        if (accuracy < 8 && lecturasGPS.length >= 2) {
                            console.log('🎯 Precisión PERFECTA alcanzada');
                            finalizarCaptura();
                            return;
                        }
                        
                        // 2. Precisión excelente (< 12m) con 3+ lecturas
                        if (accuracy < 12 && lecturasGPS.length >= 3) {
                            console.log('🎯 Precisión EXCELENTE alcanzada');
                            finalizarCaptura();
                            return;
                        }
                        
                        // 3. Precisión muy buena (< 20m) con 4+ lecturas
                        if (accuracy < 20 && lecturasGPS.length >= 4) {
                            console.log('✅ Precisión MUY BUENA alcanzada');
                            finalizarCaptura();
                            return;
                        }
                        
                        // 4. Máximo de lecturas alcanzado
                        if (lecturasGPS.length >= maxLecturas) {
                            console.log('📊 Máximo de lecturas alcanzado');
                            finalizarCaptura();
                            return;
                        }
                    } else {
                        console.log(`⚠️ Lectura descartada: ${accuracy.toFixed(1)}m (muy imprecisa)`);
                    }
                },
                function(error) {
                    // Error al obtener ubicación
                    if (lecturasGPS.length > 0) {
                        // Si ya tenemos alguna lectura, usarla
                        console.log('⚠️ Error en GPS, usando lecturas disponibles');
                        finalizarCaptura();
                        return;
                    }
                    
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '❌ Permiso denegado. Active el GPS en configuración.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '❌ GPS no disponible. Salga al exterior para mejor señal.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '❌ GPS no responde. Intente en un lugar abierto.';
                            break;
                        default:
                            errorMsg = '❌ Error de GPS. Intente nuevamente.';
                            break;
                    }
                    
                    status.textContent = errorMsg;
                    status.style.color = '#d32f2f';
                    
                    btn.disabled = false;
                    btn.innerHTML = '<span>📍</span> Obtener Ubicación Actual';
                },
                {
                    enableHighAccuracy: true,      // GPS de alta precisión (NO WiFi/Cell)
                    timeout: 6000,                 // 6 segundos por lectura
                    maximumAge: 0                  // Siempre coordenadas frescas
                }
            );
            
            // Timeout de seguridad: finalizar después de 8 segundos con lo que tengamos
            timeoutId = setTimeout(() => {
                if (lecturasGPS.length > 0) {
                    console.log(`⏱️ Timeout (8s) - Finalizando con ${lecturasGPS.length} lecturas`);
                    finalizarCaptura();
                } else {
                    // No hay lecturas después de 8 segundos
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    status.textContent = '❌ No se pudo obtener señal GPS. Intente en exterior.';
                    status.style.color = '#d32f2f';
                    btn.disabled = false;
                    btn.innerHTML = '<span>📍</span> Obtener Ubicación Actual';
                }
            }, tiempoMaximo);
        }
        
        function finalizarCaptura() {
            const btn = document.getElementById('btnObtenerUbicacion');
            const status = document.getElementById('ubicacionStatus');
            const mapaContainer = document.getElementById('mapaUbicacionContainer');
            
            // Detener el watchPosition y timeouts
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            
            if (lecturasGPS.length === 0) {
                status.textContent = '❌ No se pudo capturar GPS. Intente en exterior.';
                status.style.color = '#d32f2f';
                btn.disabled = false;
                btn.innerHTML = '<span>📍</span> Obtener Ubicación Actual';
                return;
            }
            
            // Ordenar por precisión (menor accuracy = mejor)
            lecturasGPS.sort((a, b) => a.accuracy - b.accuracy);
            
            // ALGORITMO INTELIGENTE: Usar las mejores lecturas según cantidad disponible
            let mejoresLecturas;
            if (lecturasGPS.length === 1) {
                // Solo 1 lectura: usarla directamente
                mejoresLecturas = lecturasGPS;
            } else if (lecturasGPS.length === 2) {
                // 2 lecturas: promediar ambas si son similares
                if (lecturasGPS[1].accuracy < lecturasGPS[0].accuracy * 2) {
                    mejoresLecturas = lecturasGPS;
                } else {
                    mejoresLecturas = [lecturasGPS[0]]; // Solo la mejor
                }
            } else {
                // 3+ lecturas: tomar las 3 mejores y promediarlas
                mejoresLecturas = lecturasGPS.slice(0, Math.min(4, lecturasGPS.length));
                // Filtrar outliers: solo usar lecturas con precisión similar a la mejor
                mejoresLecturas = mejoresLecturas.filter(l => l.accuracy < lecturasGPS[0].accuracy * 2.5);
            }
            
            // Calcular promedio ponderado (dar más peso a lecturas más precisas)
            let sumLat = 0, sumLng = 0, sumPesos = 0;
            
            mejoresLecturas.forEach(lectura => {
                // Peso inversamente proporcional a accuracy (más precisión = más peso)
                const peso = 1 / (lectura.accuracy + 1);
                sumLat += lectura.lat * peso;
                sumLng += lectura.lng * peso;
                sumPesos += peso;
            });
            
            const lat = sumLat / sumPesos;
            const lng = sumLng / sumPesos;
            const accuracy = mejoresLecturas[0].accuracy; // Usar la mejor precisión conseguida
            
            console.log(`✅ UBICACIÓN FINAL:`);
            console.log(`   📍 Lat: ${lat.toFixed(8)}`);
            console.log(`   📍 Lng: ${lng.toFixed(8)}`);
            console.log(`   🎯 Precisión: ${accuracy.toFixed(1)}m`);
            console.log(`   📊 ${mejoresLecturas.length} mejores de ${lecturasGPS.length} lecturas`);
            
            ubicacionActual = {
                latitud: lat,
                longitud: lng,
                precision: accuracy,
                timestamp: new Date().toISOString(),
                lecturas: lecturasGPS.length,
                altitud: mejoresLecturas[0].altitude,
                altitudPrecision: mejoresLecturas[0].altitudeAccuracy
            };
            
            // Zoom dinámico según precisión
            let zoomLevel = 18;
            let bboxSize = 0.0008; // Muy cercano por defecto
            
            if (accuracy > 50) {
                zoomLevel = 16;
                bboxSize = 0.002;
            } else if (accuracy > 20) {
                zoomLevel = 17;
                bboxSize = 0.001;
            }
            
            // Actualizar el mapa con OpenStreetMap
            const mapaIframe = document.getElementById('mapaUbicacion');
            mapaIframe.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-bboxSize},${lat-bboxSize},${lng+bboxSize},${lat+bboxSize}&layer=mapnik&marker=${lat},${lng}`;
            
            // URL de imagen estática para el PDF con zoom apropiado
            ubicacionActual.mapaImagenUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lng}&zoom=${zoomLevel}&size=800x500&markers=${lat},${lng},red-pushpin`;
            
            // Indicador de calidad visual
            let icono = '';
            let precisionTexto = '';
            let colorPrecision = '#4caf50';
            
            if (accuracy < 8) {
                icono = '🎯';
                precisionTexto = 'PERFECTA';
                colorPrecision = '#00c853';
            } else if (accuracy < 15) {
                icono = '🎯';
                precisionTexto = 'EXCELENTE';
                colorPrecision = '#4caf50';
            } else if (accuracy < 25) {
                icono = '✅';
                precisionTexto = 'MUY BUENA';
                colorPrecision = '#66bb6a';
            } else if (accuracy < 50) {
                icono = '✅';
                precisionTexto = 'BUENA';
                colorPrecision = '#9ccc65';
            } else if (accuracy < 100) {
                icono = '⚠️';
                precisionTexto = 'ACEPTABLE';
                colorPrecision = '#ffa726';
            } else {
                icono = '⚠️';
                precisionTexto = 'BAJA';
                colorPrecision = '#ff7043';
            }
            
            // Mostrar coordenadas con máxima precisión
            document.getElementById('coordenadasTexto').textContent = 
                `Lat: ${lat.toFixed(8)}, Lng: ${lng.toFixed(8)}\n${icono} ${accuracy.toFixed(1)}m - Precisión ${precisionTexto}`;
            
            // Mostrar el contenedor del mapa
            mapaContainer.style.display = 'block';
            
            // Actualizar estado con color según precisión
            status.textContent = `${icono} GPS capturado: ${accuracy.toFixed(1)}m (${precisionTexto})`;
            status.style.color = colorPrecision;
            
            // Pre-cargar la imagen del mapa estático
            cargarImagenMapaEstatico(lat, lng);
            
            // Restaurar botón
            btn.disabled = false;
            btn.innerHTML = '<span>📍</span> Actualizar Ubicación';
        }

        class VisitFormApp {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 8;
                this.formData = {};
                this.photos = [];
                this.sketchData = null;
                this.locationSketchData = null;
                this.signatureData = null;
                this.verifierSignatureData = null;
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.currentTool = 'draw';
                this.currentThickness = 2;
                this.sketchHistory = [];
                this.sketchHistoryIndex = -1;
                this.locationHistory = [];
                this.locationHistoryIndex = -1;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupCanvas();
                this.loadSavedData();
                this.updateProgress();
                this.setCurrentDate();
            }

            setupEventListeners() {
                // Navigation buttons
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
                document.getElementById('submitBtn').addEventListener('click', (e) => this.submitForm(e));

                // Form inputs for auto-save
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.autoSave());
                    input.addEventListener('change', () => this.autoSave());
                });

                // Radio and checkbox handlers
                this.setupRadioCheckboxHandlers();

                // Location button (only if it exists)
                const locationBtn = document.getElementById('getLocationBtn');
                if (locationBtn) {
                    locationBtn.addEventListener('click', () => this.getCurrentLocation());
                }

                // File upload - Camera and Gallery inputs
                const photosCameraInput = document.getElementById('photos-camera');
                const photosGalleryInput = document.getElementById('photos-gallery');
                const photos2CameraInput = document.getElementById('photos2-camera');
                const photos2GalleryInput = document.getElementById('photos2-gallery');
                
                if (photosCameraInput) {
                    photosCameraInput.addEventListener('change', (e) => this.handlePhotoUpload(e));
                }
                if (photosGalleryInput) {
                    photosGalleryInput.addEventListener('change', (e) => this.handlePhotoUpload(e));
                }
                if (photos2CameraInput) {
                    photos2CameraInput.addEventListener('change', (e) => this.handlePhotoUpload(e));
                }
                if (photos2GalleryInput) {
                    photos2GalleryInput.addEventListener('change', (e) => this.handlePhotoUpload(e));
                }

                // Canvas tools
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.setTool(e.target.closest('.tool-btn').dataset.tool));
                });

                document.querySelectorAll('.tool-btn[data-thickness]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.setThickness(e.target.closest('.tool-btn').dataset.thickness));
                });

                // Canvas action buttons (only if they exist)
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) {
                    undoBtn.addEventListener('click', () => this.undoSketch());
                }
                
                const clearSketchBtn = document.getElementById('clearSketchBtn');
                if (clearSketchBtn) {
                    clearSketchBtn.addEventListener('click', () => this.clearSketch());
                }
                
                const undoLocationBtn = document.getElementById('undoLocationBtn');
                if (undoLocationBtn) {
                    undoLocationBtn.addEventListener('click', () => this.undoLocation());
                }
                
                const clearLocationBtn = document.getElementById('clearLocationBtn');
                if (clearLocationBtn) {
                    clearLocationBtn.addEventListener('click', () => this.clearLocation());
                }
                
                const clearSignatureBtn = document.getElementById('clearSignatureBtn');
                if (clearSignatureBtn) {
                    clearSignatureBtn.addEventListener('click', () => this.clearSignature());
                }
                
                const clearVerifierSignatureBtn = document.getElementById('clearVerifierSignatureBtn');
                if (clearVerifierSignatureBtn) {
                    clearVerifierSignatureBtn.addEventListener('click', () => this.clearVerifierSignature());
                }

                // Form validation
                inputs.forEach(input => {
                    input.addEventListener('blur', () => this.validateField(input));
                });
            }

            setupRadioCheckboxHandlers() {
                // Radio buttons
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const name = e.target.name;
                        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                            r.closest('.radio-item').classList.remove('selected');
                        });
                        e.target.closest('.radio-item').classList.add('selected');
                    });
                });

                // Checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            e.target.closest('.checkbox-item').classList.add('selected');
                        } else {
                            e.target.closest('.checkbox-item').classList.remove('selected');
                        }
                    });
                });
            }

            setupCanvas() {
                // Sketch canvas
                this.sketchCanvas = document.getElementById('sketchCanvas');
                this.sketchCtx = this.sketchCanvas.getContext('2d');
                this.setupCanvasDrawing(this.sketchCanvas, this.sketchCtx, 'sketch');

                // Location canvas
                this.locationCanvas = document.getElementById('locationCanvas');
                this.locationCtx = this.locationCanvas.getContext('2d');
                this.setupCanvasDrawing(this.locationCanvas, this.locationCtx, 'location');

                // Signature canvas
                this.signatureCanvas = document.getElementById('signatureCanvas');
                this.signatureCtx = this.signatureCanvas.getContext('2d');
                this.setupCanvasDrawing(this.signatureCanvas, this.signatureCtx, 'signature');

                // Verifier signature canvas
                this.verifierSignatureCanvas = document.getElementById('verifierSignatureCanvas');
                this.verifierSignatureCtx = this.verifierSignatureCanvas.getContext('2d');
                this.setupCanvasDrawing(this.verifierSignatureCanvas, this.verifierSignatureCtx, 'verifierSignature');

                // Make canvas responsive
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            setupCanvasDrawing(canvas, ctx, type) {
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#333';

                // Use Pointer Events when available (modern browsers)
                if (window.PointerEvent) {
                    canvas.addEventListener('pointerdown', (e) => {
                        if (e.pointerType === 'mouse' && e.button !== 0) return;
                        e.preventDefault();
                        try { canvas.setPointerCapture(e.pointerId); } catch (err) {}
                        this.activePointerId = e.pointerId;
                        this.isDrawing = true;
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        this.lastX = (e.clientX - rect.left) * scaleX;
                        this.lastY = (e.clientY - rect.top) * scaleY;
                        if (type === 'sketch') this.saveSketchState();
                    });

                    canvas.addEventListener('pointermove', (e) => {
                        if (!this.isDrawing || this.activePointerId !== e.pointerId) return;
                        if (e.pointerType === 'mouse' && (e.buttons === 0)) return;
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        const currentX = (e.clientX - rect.left) * scaleX;
                        const currentY = (e.clientY - rect.top) * scaleY;
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.lineWidth = this.currentThickness;
                        ctx.beginPath();
                        ctx.moveTo(this.lastX, this.lastY);
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                        this.lastX = currentX;
                        this.lastY = currentY;
                    });

                    const endPointer = (e) => {
                        if (this.activePointerId !== undefined && e && e.pointerId !== this.activePointerId) return;
                        try { if (this.activePointerId !== undefined) canvas.releasePointerCapture(this.activePointerId); } catch (err) {}
                        if (this.isDrawing) {
                            this.isDrawing = false;
                            this.activePointerId = undefined;
                            this.stopDrawing(type);
                        }
                    };

                    canvas.addEventListener('pointerup', endPointer);
                    canvas.addEventListener('pointercancel', endPointer);
                    canvas.addEventListener('pointerleave', (e) => {
                        if (this.isDrawing && this.activePointerId === e.pointerId) endPointer(e);
                    });
                } else {
                    // Fallback for older browsers: mouse + touch
                    // Mouse
                    canvas.addEventListener('mousedown', (e) => {
                        if (e.button !== 0) return;
                        e.preventDefault();
                        this.isDrawing = true;
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        this.lastX = (e.clientX - rect.left) * scaleX;
                        this.lastY = (e.clientY - rect.top) * scaleY;
                        if (type === 'sketch') this.saveSketchState();
                    });

                    window.addEventListener('mousemove', (e) => {
                        if (!this.isDrawing) return;
                        // Ensure the pointer is within the canvas bounds
                        const rect = canvas.getBoundingClientRect();
                        if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        const currentX = (e.clientX - rect.left) * scaleX;
                        const currentY = (e.clientY - rect.top) * scaleY;
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.lineWidth = this.currentThickness;
                        ctx.beginPath();
                        ctx.moveTo(this.lastX, this.lastY);
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                        this.lastX = currentX;
                        this.lastY = currentY;
                    });

                    window.addEventListener('mouseup', (e) => {
                        if (this.isDrawing) {
                            this.isDrawing = false;
                            this.stopDrawing(type);
                        }
                    });

                    // Touch
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        this.isDrawing = true;
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        this.lastX = (touch.clientX - rect.left) * scaleX;
                        this.lastY = (touch.clientY - rect.top) * scaleY;
                        if (type === 'sketch') this.saveSketchState();
                    }, { passive: false });

                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!this.isDrawing) return;
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        // ignore moves outside
                        if (touch.clientX < rect.left || touch.clientX > rect.right || touch.clientY < rect.top || touch.clientY > rect.bottom) return;
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        const currentX = (touch.clientX - rect.left) * scaleX;
                        const currentY = (touch.clientY - rect.top) * scaleY;
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.lineWidth = this.currentThickness;
                        ctx.beginPath();
                        ctx.moveTo(this.lastX, this.lastY);
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                        this.lastX = currentX;
                        this.lastY = currentY;
                    }, { passive: false });

                    canvas.addEventListener('touchend', (e) => {
                        if (this.isDrawing) {
                            this.isDrawing = false;
                            this.stopDrawing(type);
                        }
                    });
                }
            }

            startDrawing(e, ctx, type) {
                this.isDrawing = true;
                const rect = e.target.getBoundingClientRect();
                const scaleX = e.target.width / rect.width;
                const scaleY = e.target.height / rect.height;
                this.lastX = (e.clientX - rect.left) * scaleX;
                this.lastY = (e.clientY - rect.top) * scaleY;

                if (type === 'sketch') {
                    this.saveSketchState();
                }
            }

            draw(e, ctx, type) {
                if (!this.isDrawing) return;

                const rect = e.target.getBoundingClientRect();
                const scaleX = e.target.width / rect.width;
                const scaleY = e.target.height / rect.height;
                const currentX = (e.clientX - rect.left) * scaleX;
                const currentY = (e.clientY - rect.top) * scaleY;

                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = this.currentThickness;
                ctx.beginPath();
                ctx.moveTo(this.lastX, this.lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();

                this.lastX = currentX;
                this.lastY = currentY;
            }

            stopDrawing(type) {
                if (!this.isDrawing) return;
                this.isDrawing = false;

                // Save canvas data
                if (type === 'sketch') {
                    this.sketchData = this.sketchCanvas.toDataURL();
                } else if (type === 'location') {
                    this.locationSketchData = this.locationCanvas.toDataURL();
                } else if (type === 'signature') {
                    this.signatureData = this.signatureCanvas.toDataURL();
                } else if (type === 'verifierSignature') {
                    this.verifierSignatureData = this.verifierSignatureCanvas.toDataURL();
                }

                this.autoSave();
            }

            setTool(tool) {
                this.currentTool = tool;
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            }

            setThickness(thickness) {
                this.currentThickness = parseInt(thickness);
                document.querySelectorAll('.tool-btn[data-thickness]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-thickness="${thickness}"]`).classList.add('active');
            }

            saveSketchState() {
                this.sketchHistoryIndex++;
                if (this.sketchHistoryIndex < this.sketchHistory.length) {
                    this.sketchHistory.length = this.sketchHistoryIndex;
                }
                this.sketchHistory.push(this.sketchCtx.getImageData(0, 0, this.sketchCanvas.width, this.sketchCanvas.height));
            }

            undoSketch() {
                if (this.sketchHistoryIndex > 0) {
                    this.sketchHistoryIndex--;
                    this.sketchCtx.putImageData(this.sketchHistory[this.sketchHistoryIndex], 0, 0);
                    this.sketchData = this.sketchCanvas.toDataURL();
                    this.autoSave();
                }
            }

            clearSketch() {
                this.sketchCtx.clearRect(0, 0, this.sketchCanvas.width, this.sketchCanvas.height);
                this.sketchData = null;
                this.sketchHistory = [];
                this.sketchHistoryIndex = -1;
                this.saveSketchState();
                this.autoSave();
            }

            clearLocation() {
                this.locationCtx.clearRect(0, 0, this.locationCanvas.width, this.locationCanvas.height);
                this.locationSketchData = null;
                this.locationHistory = [];
                this.locationHistoryIndex = -1;
                this.autoSave();
            }

            undoLocation() {
                if (this.locationHistoryIndex > 0) {
                    this.locationHistoryIndex--;
                    const imageData = this.locationHistory[this.locationHistoryIndex];
                    this.locationCtx.putImageData(imageData, 0, 0);
                    this.locationSketchData = this.locationCanvas.toDataURL();
                    this.autoSave();
                }
            }

            clearSignature() {
                this.signatureCtx.clearRect(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
                this.signatureData = null;
                this.autoSave();
                document.getElementById('signatureError').classList.remove('show');
            }

            clearVerifierSignature() {
                this.verifierSignatureCtx.clearRect(0, 0, this.verifierSignatureCanvas.width, this.verifierSignatureCanvas.height);
                this.verifierSignatureData = null;
                this.autoSave();
                document.getElementById('verifierSignatureError').classList.remove('show');
            }

            resizeCanvas() {
                const containers = document.querySelectorAll('.canvas-container');
                containers.forEach(container => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        const maxWidth = container.clientWidth - 32;
                        if (canvas.width > maxWidth) {
                            const ratio = canvas.height / canvas.width;
                            canvas.style.width = maxWidth + 'px';
                            canvas.style.height = (maxWidth * ratio) + 'px';
                        }
                    }
                });
            }

            getCurrentLocation() {
                const btn = document.getElementById('getLocationBtn');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span>⏳</span> Obteniendo ubicación...';
                btn.disabled = true;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            document.getElementById('latitud').value = position.coords.latitude.toFixed(6);
                            document.getElementById('longitud').value = position.coords.longitude.toFixed(6);
                            btn.innerHTML = '<span>✓</span> Ubicación obtenida';
                            btn.style.background = '#28a745';
                            this.autoSave();
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                                btn.style.background = '';
                            }, 2000);
                        },
                        (error) => {
                            btn.innerHTML = '<span>❌</span> Error al obtener ubicación';
                            btn.style.background = '#dc3545';
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                                btn.style.background = '';
                            }, 2000);
                        }
                    );
                } else {
                    btn.innerHTML = '<span>❌</span> Geolocalización no soportada';
                    btn.disabled = false;
                }
            }

            handlePhotoUpload(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('photoPreview');

                files.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = this.compressImage(e.target.result, (compressedData) => {
                                this.photos.push({
                                    name: file.name,
                                    data: compressedData,
                                    size: file.size
                                });

                                const photoItem = document.createElement('div');
                                photoItem.className = 'photo-item';
                                photoItem.innerHTML = `
                                    <img src="${compressedData}" alt="Foto ${this.photos.length}">
                                    <button type="button" class="photo-remove" onclick="app.removePhoto(${this.photos.length - 1})">×</button>
                                `;
                                preview.appendChild(photoItem);
                                this.autoSave();
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Clear input
                e.target.value = '';
            }

            compressImage(src, callback, quality = 0.8) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Resize if too large
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let { width, height } = img;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = src;
            }

            removePhoto(index) {
                this.photos.splice(index, 1);
                this.refreshPhotoPreview();
                this.autoSave();
            }

            refreshPhotoPreview() {
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = '';
                this.photos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.data}" alt="Foto ${index + 1}">
                        <button type="button" class="photo-remove" onclick="app.removePhoto(${index})">×</button>
                    `;
                    preview.appendChild(photoItem);
                });
            }

            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fechaVisita').value = today;
            }

            validateStep(stepNumber) {
                const stepElement = document.querySelector(`[data-step="${stepNumber}"]`);
                const requiredFields = stepElement.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });

                // Special validation for signatures in step 8
                if (stepNumber === 8) {
                    if (!this.signatureData) {
                        document.getElementById('signatureError').classList.add('show');
                        isValid = false;
                    } else {
                        document.getElementById('signatureError').classList.remove('show');
                    }
                    
                    if (!this.verifierSignatureData) {
                        document.getElementById('verifierSignatureError').classList.add('show');
                        isValid = false;
                    } else {
                        document.getElementById('verifierSignatureError').classList.remove('show');
                    }
                }

                return isValid;
            }

            validateField(field) {
                const value = field.value.trim();
                const errorElement = field.nextElementSibling;
                let isValid = true;

                // Required field validation
                if (field.required && !value) {
                    isValid = false;
                }

                // Specific field validations
                switch (field.type) {
                    case 'email':
                        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                            isValid = false;
                        }
                        break;
                    case 'tel':
                        if (value && !/^[0-9\-\+\s\(\)]{8,15}$/.test(value)) {
                            isValid = false;
                        }
                        break;
                }

                // Pattern validation
                if (field.pattern && value && !new RegExp(field.pattern).test(value)) {
                    isValid = false;
                }

                // DPI specific validation
                if (field.id === 'dpi' && value && (!/^\d{13}$/.test(value))) {
                    isValid = false;
                }

                // Update UI
                if (isValid) {
                    field.classList.remove('error');
                    if (errorElement && errorElement.classList.contains('error-message')) {
                        errorElement.classList.remove('show');
                    }
                } else {
                    field.classList.add('error');
                    if (errorElement && errorElement.classList.contains('error-message')) {
                        errorElement.classList.add('show');
                    }
                }

                return isValid;
            }

            nextStep() {
                console.log(`Intentando pasar del paso ${this.currentStep} al ${this.currentStep + 1}`);
                
                // Comentar temporalmente la validación para debugging
                // if (!this.validateStep(this.currentStep)) {
                //     console.log(`Validación falló para el paso ${this.currentStep}`);
                //     return;
                // }

                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    console.log(`Moviendo al paso ${this.currentStep}`);
                    this.updateStep();
                } else {
                    console.log('Ya estamos en el último paso');
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    console.log(`Retrocediendo al paso ${this.currentStep}`);
                    this.updateStep();
                }
            }

            updateStep() {
                console.log(`Actualizando UI para mostrar paso ${this.currentStep}`);
                
                // Hide all steps
                document.querySelectorAll('.form-step').forEach((step, index) => {
                    step.classList.remove('active');
                    console.log(`Ocultando paso ${index + 1}`);
                });

                // Show current step
                const currentStepElement = document.querySelector(`.form-step[data-step="${this.currentStep}"]`);
                if (currentStepElement) {
                    currentStepElement.classList.add('active');
                    console.log(`Mostrando paso ${this.currentStep}`);
                } else {
                    console.error(`No se encontró el elemento del paso ${this.currentStep}`);
                }

                // Update progress
                this.updateProgress();

                // Update buttons
                this.updateButtons();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            updateProgress() {
                const progress = (this.currentStep / this.totalSteps) * 100;
                document.querySelector('.progress-bar-fill').style.width = `${progress}%`;

                // Update step indicators
                document.querySelectorAll('.progress-step').forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNumber === this.currentStep) {
                        step.classList.add('active');
                    } else if (stepNumber < this.currentStep) {
                        step.classList.add('completed');
                        step.querySelector('.step-icon').innerHTML = '✓';
                    } else {
                        step.querySelector('.step-icon').innerHTML = stepNumber;
                    }
                });
            }

            updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const submitBtn = document.getElementById('submitBtn');
                const pdfBtn = document.getElementById('pdfBtn');

                if (this.currentStep === 1) {
                    prevBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'flex';
                }

                if (this.currentStep === this.totalSteps) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'flex';
                    pdfBtn.style.display = 'flex';
                } else {
                    nextBtn.style.display = 'flex';
                    submitBtn.style.display = 'none';
                    pdfBtn.style.display = 'none';
                }
            }

            autoSave() {
                this.collectFormData();
                this.saveToStorage();
                this.showAutoSaveIndicator();
            }

            collectFormData() {
                const formData = new FormData(document.getElementById('visitForm'));
                this.formData = {};

                // Basic form fields
                for (let [key, value] of formData.entries()) {
                    if (this.formData[key]) {
                        // Handle multiple values (checkboxes)
                        if (Array.isArray(this.formData[key])) {
                            this.formData[key].push(value);
                        } else {
                            this.formData[key] = [this.formData[key], value];
                        }
                    } else {
                        this.formData[key] = value;
                    }
                }

                // Handle checkboxes separately
                const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                const servicios = [];
                checkboxes.forEach(cb => {
                    if (cb.name === 'servicios') {
                        servicios.push(cb.value);
                    }
                });
                if (servicios.length > 0) {
                    this.formData.servicios = servicios;
                }

                // Add canvas data
                this.formData.croquis = this.sketchData;
                this.formData.firma = this.signatureData;
                this.formData.fotos = this.photos;

                // Add metadata
                this.formData._metadata = {
                    lastModified: new Date().toISOString(),
                    currentStep: this.currentStep,
                    version: '1.0'
                };
            }

            saveToStorage() {
                try {
                    const dataToSave = {
                        formData: this.formData,
                        currentStep: this.currentStep,
                        photos: this.photos,
                        sketchData: this.sketchData,
                        signatureData: this.signatureData
                    };
                    
                    // Use a simple in-memory storage since localStorage is not available
                    window.visitFormBackup = dataToSave;
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }

            loadSavedData() {
                try {
                    const savedData = window.visitFormBackup;
                    if (savedData) {
                        this.formData = savedData.formData || {};
                        this.currentStep = savedData.currentStep || 1;
                        this.photos = savedData.photos || [];
                        this.sketchData = savedData.sketchData;
                        this.signatureData = savedData.signatureData;

                        this.restoreFormFields();
                        this.refreshPhotoPreview();
                        this.restoreCanvasData();
                        this.updateStep();
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }

            restoreFormFields() {
                Object.keys(this.formData).forEach(key => {
                    const field = document.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'radio') {
                            const radioOption = document.querySelector(`[name="${key}"][value="${this.formData[key]}"]`);
                            if (radioOption) {
                                radioOption.checked = true;
                                radioOption.closest('.radio-item').classList.add('selected');
                            }
                        } else if (field.type === 'checkbox') {
                            const values = Array.isArray(this.formData[key]) ? this.formData[key] : [this.formData[key]];
                            values.forEach(value => {
                                const checkbox = document.querySelector(`[name="${key}"][value="${value}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    checkbox.closest('.checkbox-item').classList.add('selected');
                                }
                            });
                        } else {
                            field.value = this.formData[key];
                        }
                    }
                });
            }

            restoreCanvasData() {
                if (this.sketchData) {
                    const img = new Image();
                    img.onload = () => {
                        this.sketchCtx.drawImage(img, 0, 0);
                    };
                    img.src = this.sketchData;
                }

                if (this.signatureData) {
                    const img = new Image();
                    img.onload = () => {
                        this.signatureCtx.drawImage(img, 0, 0);
                    };
                    img.src = this.signatureData;
                }
            }

            showAutoSaveIndicator() {
                const indicator = document.getElementById('autoSave');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            async submitForm(e) {
                e.preventDefault();

                if (!this.validateStep(this.currentStep)) {
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.innerHTML = '<span>⏳</span> Enviando...';
                submitBtn.disabled = true;

                try {
                    this.collectFormData();
                    
                    // Simulate API call
                    await this.mockApiSubmission();

                    // Show success message
                    document.getElementById('successMessage').classList.add('show');

                    // Export options
                    this.exportToJSON();
                    this.exportToCSV();

                    submitBtn.innerHTML = '<span>✓</span> Enviado';
                    submitBtn.style.background = '#28a745';

                    // Clear saved data
                    delete window.visitFormBackup;

                } catch (error) {
                    console.error('Error submitting form:', error);
                    submitBtn.innerHTML = '<span>❌</span> Error al enviar';
                    submitBtn.style.background = '#dc3545';
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.background = '';
                    }, 3000);
                }
            }

            async mockApiSubmission() {
                // Simulate API call
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('Form data submitted:', this.formData);
                        resolve();
                    }, 2000);
                });
            }

            exportToJSON() {
                const exportData = {
                    ...this.formData,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formulario_visita_${new Date().getTime()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            exportToCSV() {
                // Define CSV headers based on form structure
                const headers = [
                    'Nombres',
                    'Apellidos',
                    'DPI',
                    'Telefono',
                    'Email',
                    'Fecha_Nacimiento',
                    'Genero',
                    'Departamento',
                    'Municipio',
                    'Direccion',
                    'Zona',
                    'Aldea',
                    'Latitud',
                    'Longitud',
                    'Tipo_Vivienda',
                    'Material_Paredes',
                    'Material_Techo',
                    'Material_Piso',
                    'Numero_Habitaciones',
                    'Numero_Banos',
                    'Servicios_Disponibles',
                    'Condicion_Vivienda',
                    'Observaciones',
                    'Recomendaciones',
                    'Fecha_Visita',
                    'Verificador',
                    'Num_Fotos',
                    'Tiene_Croquis',
                    'Tiene_Firma'
                ];

                const csvRow = [
                    this.formData.nombres || '',
                    this.formData.apellidos || '',
                    this.formData.dpi || '',
                    this.formData.telefono || '',
                    this.formData.email || '',
                    this.formData.fechaNacimiento || '',
                    this.formData.genero || '',
                    this.formData.departamento || '',
                    this.formData.municipio || '',
                    this.formData.direccion || '',
                    this.formData.zona || '',
                    this.formData.aldea || '',
                    this.formData.latitud || '',
                    this.formData.longitud || '',
                    this.formData.tipoVivienda || '',
                    this.formData.materialParedes || '',
                    this.formData.materialTecho || '',
                    this.formData.materialPiso || '',
                    this.formData.numeroHabitaciones || '',
                    this.formData.numeroBanos || '',
                    Array.isArray(this.formData.servicios) ? this.formData.servicios.join(';') : '',
                    this.formData.condicionVivienda || '',
                    this.formData.observaciones || '',
                    this.formData.recomendaciones || '',
                    this.formData.fechaVisita || '',
                    this.formData.verificador || '',
                    this.photos.length,
                    this.sketchData ? 'Sí' : 'No',
                    this.signatureData ? 'Sí' : 'No'
                ];

                const csvContent = [
                    headers.join(','),
                    csvRow.map(field => `"${field}"`).join(',')
                ].join('\n');

                const blob = new Blob([csvContent], {
                    type: 'text/csv;charset=utf-8'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formulario_visita_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize app
        const app = new VisitFormApp();
        window.app = app; // Hacer la instancia disponible globalmente

        // Make removePhoto available globally for onclick handlers
        window.removePhoto = (index) => app.removePhoto(index);

        // Funciones para campos dinámicos
        function agregarProveedor() {
            const container = document.getElementById('proveedoresContainer');
            const div = document.createElement('div');
            div.className = 'proveedor-item dynamic-item';
            div.innerHTML = `
                <div class="form-grid two-columns">
                    <input type="text" name="proveedor[]" placeholder="Nombre del proveedor" maxlength="100">
                    <div class="dynamic-buttons">
                        <input type="number" name="montoProveedor[]" placeholder="Monto Q" min="0" step="0.01">
                        <button type="button" class="btn btn-danger" onclick="eliminarElemento(this)">❌</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarMobiliario() {
            const container = document.getElementById('mobiliarioContainer');
            const div = document.createElement('div');
            div.className = 'mobiliario-item dynamic-item';
            div.innerHTML = `
                <div class="form-grid two-columns">
                    <input type="text" name="mobiliario[]" placeholder="Descripción" maxlength="100">
                    <div class="dynamic-buttons">
                        <input type="number" name="valorMobiliario[]" placeholder="Valor Q" min="0" step="0.01">
                        <button type="button" class="btn btn-danger" onclick="eliminarElemento(this)">❌</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarMercaderia() {
            const container = document.getElementById('mercaderiaContainer');
            const div = document.createElement('div');
            div.className = 'mercaderia-item dynamic-item';
            div.innerHTML = `
                <div class="form-grid two-columns">
                    <input type="text" name="mercaderia[]" placeholder="Descripción" maxlength="100">
                    <div class="dynamic-buttons">
                        <input type="number" name="valorMercaderia[]" placeholder="Valor Q" min="0" step="0.01">
                        <button type="button" class="btn btn-danger" onclick="eliminarElemento(this)">❌</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarInventario() {
            const container = document.getElementById('inventarioContainer');
            const div = document.createElement('div');
            div.className = 'inventario-item dynamic-item';
            div.innerHTML = `
                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr 60px;">
                    <input type="text" name="productoDescripcion[]" placeholder="Descripción del Producto" maxlength="100">
                    <input type="number" name="productoCantidad[]" placeholder="Cantidad" min="0" onchange="calcularTotalVenta(this)">
                    <input type="number" name="productoCompra[]" placeholder="Valor Compra Q" min="0" step="0.01">
                    <input type="number" name="productoVenta[]" placeholder="Precio Venta Q" min="0" step="0.01" onchange="calcularTotalVenta(this)">
                    <input type="number" name="productoTotalVenta[]" placeholder="Total Venta Q" readonly>
                    <button type="button" class="btn btn-danger" onclick="eliminarElemento(this)">❌</button>
                </div>
            `;
            container.appendChild(div);
        }

        function agregarOtrosGastos() {
            const container = document.getElementById('otrosGastosContainer');
            const div = document.createElement('div');
            div.className = 'otros-gastos-item dynamic-item';
            div.innerHTML = `
                <div class="form-grid two-columns">
                    <input type="text" name="descripcionGasto[]" placeholder="Descripción" maxlength="100">
                    <div class="dynamic-buttons">
                        <input type="number" name="montoGasto[]" placeholder="Monto Q" min="0" step="0.01" onchange="calcularTotalCostos()">
                        <button type="button" class="btn btn-danger" onclick="eliminarElemento(this)">❌</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function eliminarElemento(button) {
            const item = button.closest('.proveedor-item, .mobiliario-item, .mercaderia-item, .inventario-item, .otros-gastos-item');
            item.remove();
            calcularTotalCostos();
        }

        function calcularTotalVenta(element) {
            const row = element.closest('.inventario-item');
            const cantidad = parseFloat(row.querySelector('input[name="productoCantidad[]"]').value) || 0;
            const precioVenta = parseFloat(row.querySelector('input[name="productoVenta[]"]').value) || 0;
            const totalVenta = cantidad * precioVenta;
            row.querySelector('input[name="productoTotalVenta[]"]').value = totalVenta.toFixed(2);
            calcularResumenFinanciero();
        }

        function calcularTotalCostos() {
            // Calcular total de costos fijos
            const costoAgua = parseFloat(document.getElementById('costoAgua').value) || 0;
            const costoLuz = parseFloat(document.getElementById('costoLuz').value) || 0;
            const costoAlquiler = parseFloat(document.getElementById('costoAlquiler').value) || 0;
            const costoTelefono = parseFloat(document.getElementById('costoTelefono').value) || 0;
            const costoBasura = parseFloat(document.getElementById('costoBasura').value) || 0;
            
            const totalCostosFijos = costoAgua + costoLuz + costoAlquiler + costoTelefono + costoBasura;
            document.getElementById('totalCostosFijos').value = totalCostosFijos.toFixed(2);
            
            calcularResumenFinanciero();
        }

        function calcularResumenFinanciero() {
            // Calcular total de ventas
            let totalVentas = 0;
            document.querySelectorAll('input[name="productoTotalVenta[]"]').forEach(input => {
                totalVentas += parseFloat(input.value) || 0;
            });
            document.getElementById('totalVentasMes').value = totalVentas.toFixed(2);
            
            // Calcular costo total (costos fijos + otros gastos)
            const totalCostosFijos = parseFloat(document.getElementById('totalCostosFijos').value) || 0;
            let otrosGastos = 0;
            document.querySelectorAll('input[name="montoGasto[]"]').forEach(input => {
                otrosGastos += parseFloat(input.value) || 0;
            });
            
            const costoTotal = totalCostosFijos + otrosGastos;
            document.getElementById('costoTotalMes').value = costoTotal.toFixed(2);
            
            // Calcular utilidad neta
            const utilidadNeta = totalVentas - costoTotal;
            document.getElementById('utilidadNeta').value = utilidadNeta.toFixed(2);
        }

        // Event listeners para cálculos automáticos
        document.addEventListener('DOMContentLoaded', function() {
            // Costos fijos
            ['costoAgua', 'costoLuz', 'costoAlquiler', 'costoTelefono', 'costoBasura'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calcularTotalCostos);
                }
            });
        });

        // Hacer las funciones disponibles globalmente
        window.agregarProveedor = agregarProveedor;
        window.agregarMobiliario = agregarMobiliario;
        window.agregarMercaderia = agregarMercaderia;
        window.agregarInventario = agregarInventario;
        window.agregarOtrosGastos = agregarOtrosGastos;
        window.eliminarElemento = eliminarElemento;
        window.calcularTotalVenta = calcularTotalVenta;
        window.calcularTotalCostos = calcularTotalCostos;

        // Función para generar PDF completo con iframe de mapa (método HTML + print) - VERSIÓN MEJORADA
        async function generarPDFConMapa() {
            console.log('🚀 Generando PDF completo con mapa y carta...');
            
            const fechaHoy = new Date();
            const fecha = fechaHoy.toLocaleDateString('es-GT', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const fechaCorta = fechaHoy.toLocaleDateString('es-GT');
            
            // Obtener canvas de croquis y firmas
            const canvasVivienda = document.getElementById('sketchCanvas');
            const canvasUbicacion = document.getElementById('locationCanvas');
            const canvasSignature = document.getElementById('signatureCanvas');
            const canvasVerifierSignature = document.getElementById('verifierSignatureCanvas');
            
            let croquisViviendaImg = '';
            let croquisUbicacionImg = '';
            let signatureImg = '';
            let verifierSignatureImg = '';
            
            if (canvasVivienda) {
                try {
                    croquisViviendaImg = canvasVivienda.toDataURL('image/png');
                    console.log('✅ Croquis vivienda capturado');
                } catch(e) {
                    console.error('❌ Error al capturar croquis vivienda:', e);
                }
            }
            
            if (canvasUbicacion) {
                try {
                    croquisUbicacionImg = canvasUbicacion.toDataURL('image/png');
                    console.log('✅ Croquis ubicación capturado');
                } catch(e) {
                    console.error('❌ Error al capturar croquis ubicación:', e);
                }
            }
            
            if (canvasSignature) {
                try {
                    signatureImg = canvasSignature.toDataURL('image/png');
                    console.log('✅ Firma del cliente capturada');
                } catch(e) {
                    console.error('❌ Error al capturar firma del cliente:', e);
                }
            }
            
            if (canvasVerifierSignature) {
                try {
                    verifierSignatureImg = canvasVerifierSignature.toDataURL('image/png');
                    console.log('✅ Firma del verificador capturada');
                } catch(e) {
                    console.error('❌ Error al capturar firma del verificador:', e);
                }
            }
            
            // Recopilar TODOS los datos del formulario con verificación
            console.log('🔍 Recopilando datos del formulario...');
            
            // Función auxiliar para obtener valor y loguearlo
            const obtenerValor = (id, nombre = id) => {
                const elemento = document.getElementById(id);
                const valor = elemento?.value || '';
                console.log(`  ${nombre}: "${valor}" ${valor ? '✅' : '⚠️ VACÍO'}`);
                return valor;
            };
            
            const obtenerRadio = (name, nombre = name) => {
                const elemento = document.querySelector(`input[name="${name}"]:checked`);
                const valor = elemento?.value || '';
                console.log(`  ${nombre}: "${valor}" ${valor ? '✅' : '⚠️ NO SELECCIONADO'}`);
                return valor;
            };
            
            const obtenerCheckboxes = (name, nombre = name) => {
                const elementos = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`));
                const valores = elementos.map(el => el.value).join(', ');
                console.log(`  ${nombre}: "${valores}" ${valores ? '✅' : '⚠️ NINGUNO'}`);
                return valores;
            };
            
            const datos = {
                // Información básica (Paso 1)
                fechaVisita: obtenerValor('fechaVisita', 'Fecha Visita'),
                tipoVerificacion: obtenerValor('tipoVerificacion', 'Tipo Verificación'),
                montoSolicitado: obtenerValor('montoSolicitado', 'Monto Solicitado'),
                nombrePropietario: obtenerValor('nombrePropietario', 'Nombre Propietario'),
                contadorFisico: obtenerValor('contadorFisico', 'Contador Físico'),
                direccion: obtenerValor('direccion', 'Dirección'),
                personaAtiende: obtenerValor('personaAtiende', 'Persona que Atendió'),
                parentesco: obtenerValor('parentesco', 'Parentesco'),
                tiempoResidencia: obtenerValor('tiempoResidencia', 'Tiempo Residencia'),
                cui: obtenerValor('cui', 'CUI/DPI'),
                telefonoCelular: obtenerValor('telefonoCelular', 'Teléfono Celular'),
                formaAdquisicion: obtenerValor('formaAdquisicion', 'Forma Adquisición'),
                quienesViven: obtenerValor('quienesViven', 'Quiénes Viven'),
                dimensionesInmueble: obtenerValor('dimensionesInmueble', 'Dimensiones Inmueble'),
                destinoCredito: obtenerValor('destinoCredito', 'Destino Crédito'),
                otroDestino: obtenerValor('otroDestino', 'Otro Destino'),
                
                // Información de la vivienda (Paso 2)
                tipoVivienda: obtenerRadio('tipoVivienda', 'Tipo Vivienda'),
                materialParedes: obtenerValor('materialParedes', 'Material Paredes'),
                materialTecho: obtenerValor('materialTecho', 'Material Techo'),
                materialPiso: obtenerValor('materialPiso', 'Material Piso'),
                numeroHabitaciones: obtenerValor('numeroHabitaciones', 'Número Habitaciones'),
                numeroBanos: obtenerValor('numeroBanos', 'Número Baños'),
                serviciosBasicos: obtenerCheckboxes('servicios', 'Servicios Disponibles'),
                condicionVivienda: obtenerRadio('condicionVivienda', 'Condición Vivienda'),
                formaIngresoGarita: obtenerValor('formaIngresoGarita', 'Forma Ingreso Garita'),
                detalleCodigo: obtenerValor('detalleCodigo', 'Código Acceso'),
                detalleMarbete: obtenerValor('detalleMarbete', 'Marbete'),
                detalleEntradaLibre: obtenerValor('detalleEntradaLibre', 'Entrada Libre Detalles'),
                
                // Información de inquilinos (Paso 3)
                contratoArrendamiento: obtenerRadio('contratoArrendamiento', 'Contrato Arrendamiento'),
                aPagarRenta: obtenerValor('aPagarRenta', 'A Pagar Renta'),
                valorRenta: obtenerValor('valorRenta', 'Valor Renta'),
                tiempoResidenciaInquilino: obtenerValor('tiempoResidenciaInquilino', 'Tiempo Residencia Inquilino'),
                formaPago: obtenerValor('formaPago', 'Forma de Pago'),
                comentariosInquilino: obtenerValor('comentariosInquilino', 'Comentarios Inquilino'),
                
                // Información del negocio (Paso 4)
                nombreNegocio: obtenerValor('nombreNegocio', 'Nombre Negocio'),
                patenteComercio: obtenerValor('patenteComercio', 'Patente Comercio'),
                giroNegocio: obtenerValor('giroNegocio', 'Giro Negocio'),
                direccionNegocio: obtenerValor('direccionNegocio', 'Dirección Negocio'),
                tipoLocal: obtenerRadio('tipoLocal', 'Tipo de Local'),
                pagoMensualLocal: obtenerValor('pagoMensualLocal', 'Pago Mensual Local'),
                tiempoOperacion: obtenerValor('tiempoOperacion', 'Tiempo Operación'),
                numeroEmpleados: obtenerValor('numeroEmpleados', 'Número Empleados'),
                ingresosMensuales: obtenerValor('ingresosMensuales', 'Ingresos Mensuales'),
                pagoMensualNegocio: obtenerValor('pagoMensualNegocio', 'Pago Mensual Negocio'),
                estadoFisicoInterior: obtenerRadio('estadoFisicoInterior', 'Estado Físico Interior'),
                estadoFisicoExterior: obtenerRadio('estadoFisicoExterior', 'Estado Físico Exterior'),
                
                // Costos Fijos
                costoAgua: obtenerValor('costoAgua', 'Costo Agua'),
                costoLuz: obtenerValor('costoLuz', 'Costo Luz'),
                costoAlquiler: obtenerValor('costoAlquiler', 'Costo Alquiler'),
                costoTelefono: obtenerValor('costoTelefono', 'Costo Teléfono'),
                costoBasura: obtenerValor('costoBasura', 'Costo Basura'),
                totalCostosFijos: obtenerValor('totalCostosFijos', 'Total Costos Fijos'),
                
                // Resumen Financiero
                totalVentasMes: obtenerValor('totalVentasMes', 'Total Ventas Mes'),
                costoTotalMes: obtenerValor('costoTotalMes', 'Costo Total Mes'),
                utilidadNeta: obtenerValor('utilidadNeta', 'Utilidad Neta'),
                
                // Información de empleo (Paso 5)
                nombreEmpresa: obtenerValor('nombreEmpresa', 'Nombre Empresa'),
                direccionEmpresa: obtenerValor('direccionEmpresa', 'Dirección Empresa'),
                igss: obtenerRadio('igss', 'IGSS'),
                puestoTrabajo: obtenerValor('puestoTrabajo', 'Puesto Trabajo'),
                salario: obtenerValor('salario', 'Salario'),
                fechaIngreso: obtenerValor('fechaIngreso', 'Fecha Ingreso'),
                telefonoEmpresa: obtenerValor('telefonoEmpresa', 'Teléfono Empresa'),
                
                // Verificación y observaciones (Paso 6)
                observacionesGenerales: obtenerValor('observacionesGenerales', 'Observaciones Generales'),
                verificador: obtenerValor('verificador', 'Verificador'),
                croquisViviendaObservaciones: obtenerValor('croquisViviendaObservaciones', 'Observaciones Croquis Vivienda'),
                
                // Tipo de autorización del cliente
                tipoAutorizacion: obtenerRadio('tipoAutorizacion', 'Tipo de Autorización'),
                motivoNoAutorizo: obtenerValor('motivoNoAutorizo', 'Motivo No Autorizó')
            };
            
            // Capturar datos dinámicos (arrays)
            console.log('📋 Capturando datos dinámicos...');
            
            // Proveedores
            const proveedores = [];
            const proveedoresNombres = document.querySelectorAll('input[name="proveedor[]"]');
            const proveedoresMontos = document.querySelectorAll('input[name="montoProveedor[]"]');
            for (let i = 0; i < proveedoresNombres.length; i++) {
                if (proveedoresNombres[i].value || proveedoresMontos[i].value) {
                    proveedores.push({
                        nombre: proveedoresNombres[i].value,
                        monto: proveedoresMontos[i].value
                    });
                }
            }
            console.log(`  Proveedores: ${proveedores.length}`);
            
            // Mobiliario
            const mobiliario = [];
            const mobiliarioDesc = document.querySelectorAll('input[name="mobiliario[]"]');
            const mobiliarioValor = document.querySelectorAll('input[name="valorMobiliario[]"]');
            for (let i = 0; i < mobiliarioDesc.length; i++) {
                if (mobiliarioDesc[i].value || mobiliarioValor[i].value) {
                    mobiliario.push({
                        descripcion: mobiliarioDesc[i].value,
                        valor: mobiliarioValor[i].value
                    });
                }
            }
            console.log(`  Mobiliario: ${mobiliario.length}`);
            
            // Mercadería
            const mercaderia = [];
            const mercaderiaDesc = document.querySelectorAll('input[name="mercaderia[]"]');
            const mercaderiaValor = document.querySelectorAll('input[name="valorMercaderia[]"]');
            for (let i = 0; i < mercaderiaDesc.length; i++) {
                if (mercaderiaDesc[i].value || mercaderiaValor[i].value) {
                    mercaderia.push({
                        descripcion: mercaderiaDesc[i].value,
                        valor: mercaderiaValor[i].value
                    });
                }
            }
            console.log(`  Mercadería: ${mercaderia.length}`);
            
            // Inventario
            const inventario = [];
            const inventarioDesc = document.querySelectorAll('input[name="productoDescripcion[]"]');
            const inventarioCant = document.querySelectorAll('input[name="productoCantidad[]"]');
            const inventarioCompra = document.querySelectorAll('input[name="productoCompra[]"]');
            const inventarioVenta = document.querySelectorAll('input[name="productoVenta[]"]');
            const inventarioTotal = document.querySelectorAll('input[name="productoTotalVenta[]"]');
            for (let i = 0; i < inventarioDesc.length; i++) {
                if (inventarioDesc[i].value || inventarioCant[i].value) {
                    inventario.push({
                        descripcion: inventarioDesc[i].value,
                        cantidad: inventarioCant[i].value,
                        compra: inventarioCompra[i].value,
                        venta: inventarioVenta[i].value,
                        total: inventarioTotal[i].value
                    });
                }
            }
            console.log(`  Inventario: ${inventario.length} productos`);
            
            // Otros Gastos
            const otrosGastos = [];
            const gastosDesc = document.querySelectorAll('input[name="descripcionGasto[]"]');
            const gastosMonto = document.querySelectorAll('input[name="montoGasto[]"]');
            for (let i = 0; i < gastosDesc.length; i++) {
                if (gastosDesc[i].value || gastosMonto[i].value) {
                    otrosGastos.push({
                        descripcion: gastosDesc[i].value,
                        monto: gastosMonto[i].value
                    });
                }
            }
            console.log(`  Otros Gastos: ${otrosGastos.length}`);
            
            // Agregar arrays al objeto datos
            datos.proveedores = proveedores;
            datos.mobiliario = mobiliario;
            datos.mercaderia = mercaderia;
            datos.inventario = inventario;
            datos.otrosGastos = otrosGastos;
            
            console.log('✅ TODOS los datos capturados exitosamente');
            
            // Obtener fotos
            const fotos = window.app?.photos || [];
            console.log(`📸 Fotos encontradas: ${fotos.length}`);
            
            // Preparar HTML de fotos - IMÁGENES COMPLETAS SIN CORTAR
            const colorPrimario = empresaSeleccionada === 'coop' ? '#a4c639' : '#FF6500';
            let fotosHTML = '';
            if (fotos.length > 0) {
                fotosHTML = `<div style="margin: 15px 0;"><h3 style="font-size: 13px; color: ${colorPrimario}; margin-bottom: 10px; font-weight: bold;">📸 Evidencia Fotográfica</h3><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">`;
                fotos.slice(0, 9).forEach(foto => {
                    const imgSrc = foto.data || foto;
                    fotosHTML += `<div style="border: 2px solid ${colorPrimario}; border-radius: 5px; padding: 3px; background: white;"><img src="${imgSrc}" style="width: 100%; height: auto; display: block; object-fit: contain;"></div>`;
                });
                fotosHTML += '</div></div>';
            }
            
            // Preparar HTML de croquis - AMBOS CROQUIS COMPLETOS
            let croquisViviendaHTML = '';
            let croquisUbicacionHTML = '';
            
            if (croquisViviendaImg) {
                croquisViviendaHTML = `<div style="margin: 10px 0;">
                    <h3 style="font-size: 13px; color: ${colorPrimario}; margin-bottom: 8px; font-weight: bold;">🗺️ Croquis de Vivienda</h3>
                    <div style="border: 2px solid ${colorPrimario}; border-radius: 5px; padding: 5px; background: white;">
                        <img src="${croquisViviendaImg}" style="width: 100%; height: auto; display: block; object-fit: contain;">
                    </div>
                </div>`;
            }
            


            if (croquisUbicacionImg) {
                croquisUbicacionHTML = `<div style="margin: 10px 0;">
                    <h3 style="font-size: 13px; color: ${colorPrimario}; margin-bottom: 8px; font-weight: bold;">🗺️ Croquis de Ubicación</h3>
                    <div style="border: 2px solid ${colorPrimario}; border-radius: 5px; padding: 5px; background: white;">
                        <img src="${croquisUbicacionImg}" style="width: 100%; height: auto; display: block; object-fit: contain;">
                    </div>
                </div>`;
            }
            
            // Preparar HTML del mapa GPS
            let mapaHTML = '';
            if (ubicacionActual) {
                mapaHTML = `
                    <div style="margin: 10px 0;">
                        <h3 style="font-size: 11px; color: ${colorPrimario}; margin-bottom: 5px;">📍 Ubicación GPS</h3>
                        <div style="border: 2px solid ${colorPrimario}; border-radius: 5px; overflow: hidden;">
                            <iframe 
                                width="100%" 
                                height="250" 
                                frameborder="0" 
                                style="border:0; display: block;" 
                                src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${ubicacionActual.latitud},${ubicacionActual.longitud}&zoom=18&maptype=satellite"
                                allowfullscreen>
                            </iframe>
                        </div>
                        <p style="font-size: 8px; margin: 5px 0; text-align: center;">
                            <strong>Coordenadas:</strong> Lat: ${ubicacionActual.latitud.toFixed(6)}, Lng: ${ubicacionActual.longitud.toFixed(6)} 
                            (Precisión: ${ubicacionActual.precision.toFixed(0)}m)
                        </p>
                        <div style="text-align: center; margin-top: 8px; page-break-inside: avoid;">
                            <a href="https://www.google.com/maps?q=${ubicacionActual.latitud},${ubicacionActual.longitud}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 20px; font-size: 11px; font-weight: bold; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);">
                                🗺️ Abrir en Google Maps
                            </a>
                            <p style="font-size: 7px; color: #666; margin-top: 4px;">
                                Click en el botón o copia: <span style="color: #667eea;">https://www.google.com/maps?q=${ubicacionActual.latitud},${ubicacionActual.longitud}</span>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            console.log('🖥️ Abriendo ventana de impresión...');
            
            // Crear ventana de impresión
            const printWindow = window.open('', '_blank', 'width=900,height=800');
            
            if (!printWindow) {
                alert('⚠️ No se pudo abrir la ventana. Por favor, permita ventanas emergentes.');
                return;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Formulario Verificación - ${datos.nombrePropietario || 'Sin nombre'}</title>
                    <style>
                        @page { 
                            size: letter; 
                            margin: 15mm; 
                        }
                        * {
                            box-sizing: border-box;
                        }
                        body { 
                            font-family: 'Arial', sans-serif; 
                            font-size: 9px; 
                            margin: 0; 
                            padding: 15px;
                            line-height: 1.4;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 15px;
                            border-bottom: 3px solid #FF6500;
                            padding-bottom: 10px;
                        }
                        h1 { 
                            color: #FF6500; 
                            font-size: 18px; 
                            margin: 0 0 5px 0;
                            font-weight: bold;
                            text-transform: uppercase;
                        }
                        .fecha-verificacion {
                            font-size: 10px;
                            color: #666;
                            margin: 5px 0;
                        }
                        .seccion { 
                            margin-bottom: 12px;
                            page-break-inside: avoid;
                        }
                        h2 { 
                            color: ${empresaSeleccionada === 'coop' ? '#a4c639' : '#FF6500'}; 
                            font-size: 12px;
                            font-weight: bold;
                            border-left: 4px solid ${empresaSeleccionada === 'coop' ? '#a4c639' : '#FF6500'};
                            padding-left: 8px;
                            margin: 8px 0 6px 0;
                            background: ${empresaSeleccionada === 'coop' ? '#f0f8e6' : '#FFF5E6'};
                            padding: 5px 8px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 6px 0;
                            font-size: 9px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 5px 8px; 
                            text-align: left; 
                            vertical-align: top; 
                        }
                        th { 
                            background-color: ${empresaSeleccionada === 'coop' ? '#f0f8e6' : '#FFF5E6'}; 
                            font-weight: bold;
                            color: ${empresaSeleccionada === 'coop' ? '#a4c639' : '#FF6500'};
                            width: 30%;
                        }
                        td {
                            background-color: white;
                        }
                        .carta-container {
                            page-break-before: always;
                            position: relative;
                            width: 794px;
                            height: 1123px;
                            margin: 0 auto;
                            overflow: hidden;
                        }
                        .carta-img {
                            width: 794px;
                            height: 1123px;
                            display: block;
                            position: absolute;
                            top: 0;
                            left: 0;
                        }
                        .texto-sobrepuesto {
                            position: absolute;
                            font-size: 12px;
                            font-weight: bold;
                            color: black;
                            font-family: Arial, sans-serif;
                            white-space: nowrap;
                        }
                        @media print {
                            body { 
                                margin: 0; 
                                padding: 15px; 
                            }
                            .no-print { 
                                display: none !important; 
                            }
                            .seccion {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📋 FORMULARIO DE VERIFICACIÓN</h1>
                        <div class="fecha-verificacion">
                            <strong>Empresa:</strong> ${empresaSeleccionada === 'coop' ? 'Coopexpress' : 'Presta Express'} | 
                            <strong>Fecha:</strong> ${fecha} | 
                            <strong>Tipo:</strong> ${datos.tipoVerificacion || 'No especificado'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>👤 INFORMACIÓN PERSONAL Y VISITA</h2>
                        <table>
                            <tr>
                                <th>Nombre del Propietario</th>
                                <td colspan="3">${datos.nombrePropietario}</td>
                            </tr>
                            <tr>
                                <th>CUI / DPI</th>
                                <td>${datos.cui}</td>
                                <th>Teléfono Celular</th>
                                <td>${datos.telefonoCelular}</td>
                            </tr>
                            <tr>
                                <th>Dirección</th>
                                <td colspan="3">${datos.direccion}</td>
                            </tr>
                            <tr>
                                <th>Persona que Atendió</th>
                                <td>${datos.personaAtiende}</td>
                                <th>Parentesco</th>
                                <td>${datos.parentesco}</td>
                            </tr>
                            <tr>
                                <th>Tiempo de Residencia</th>
                                <td>${datos.tiempoResidencia}</td>
                                <th>Contador Físico</th>
                                <td>${datos.contadorFisico}</td>
                            </tr>
                            <tr>
                                <th>Forma de Adquisición</th>
                                <td>${datos.formaAdquisicion}</td>
                                <th>Dimensiones Inmueble</th>
                                <td>${datos.dimensionesInmueble}</td>
                            </tr>
                            <tr>
                                <th>Quiénes Viven</th>
                                <td colspan="3">${datos.quienesViven}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>💰 INFORMACIÓN DEL CRÉDITO</h2>
                        <table>
                            <tr>
                                <th>Monto Solicitado</th>
                                <td colspan="3">Q ${datos.montoSolicitado}</td>
                            </tr>
                            <tr>
                                <th>Destino del Crédito</th>
                                <td colspan="3">${datos.destinoCredito}${datos.otroDestino ? ' - ' + datos.otroDestino : ''}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>🏡 INFORMACIÓN DE LA VIVIENDA</h2>
                        <table>
                            <tr>
                                <th>Tipo de Vivienda</th>
                                <td>${datos.tipoVivienda}</td>
                                <th>Condición</th>
                                <td>${datos.condicionVivienda}</td>
                            </tr>
                            <tr>
                                <th>Número de Habitaciones</th>
                                <td>${datos.numeroHabitaciones}</td>
                                <th>Material de Paredes</th>
                                <td>${datos.materialParedes}</td>
                            </tr>
                            <tr>
                                <th>Material de Techo</th>
                                <td>${datos.materialTecho}</td>
                                <th>Material de Piso</th>
                                <td>${datos.materialPiso}</td>
                            </tr>
                            <tr>
                                <th>Número de Baños</th>
                                <td>${datos.numeroBanos}</td>
                                <th>Servicios Disponibles</th>
                                <td>${datos.serviciosBasicos}</td>
                            </tr>
                        </table>
                        
                        ${datos.formaIngresoGarita ? `
                        <h3>Acceso a la Colonia/Residencial</h3>
                        <table>
                            <tr>
                                <th>Forma de Ingreso</th>
                                <td>${datos.formaIngresoGarita}</td>
                            </tr>
                            ${datos.detalleCodigo ? `<tr><th>Código</th><td>${datos.detalleCodigo}</td></tr>` : ''}
                            ${datos.detalleMarbete ? `<tr><th>Marbete</th><td>${datos.detalleMarbete}</td></tr>` : ''}
                            ${datos.detalleEntradaLibre ? `<tr><th>Detalles</th><td>${datos.detalleEntradaLibre}</td></tr>` : ''}
                        </table>
                        ` : ''}
                    </div>
                    
                    ${datos.contratoArrendamiento ? `
                    <div class="section">
                        <h2>👥 INFORMACIÓN DE INQUILINOS / ARRENDAMIENTO</h2>
                        <table>
                            <tr>
                                <th>Contrato de Arrendamiento</th>
                                <td colspan="3">${datos.contratoArrendamiento}</td>
                            </tr>
                            ${datos.aPagarRenta ? `<tr>
                                <th>A Pagar Renta</th>
                                <td>${datos.aPagarRenta}</td>
                                <th>Valor de la Renta</th>
                                <td>Q ${datos.valorRenta}</td>
                            </tr>` : ''}
                            ${datos.tiempoResidenciaInquilino ? `<tr>
                                <th>Tiempo de Residencia</th>
                                <td>${datos.tiempoResidenciaInquilino}</td>
                                <th>Forma de Pago</th>
                                <td>${datos.formaPago}</td>
                            </tr>` : ''}
                            ${datos.comentariosInquilino ? `<tr>
                                <th>Comentarios</th>
                                <td colspan="3">${datos.comentariosInquilino}</td>
                            </tr>` : ''}
                        </table>
                    </div>
                    ` : ''}
                    
                    ${datos.nombreNegocio ? `
                    <div class="section">
                        <h2>🏢 INFORMACIÓN DEL NEGOCIO</h2>
                        <table>
                            <tr>
                                <th>Nombre del Negocio</th>
                                <td>${datos.nombreNegocio}</td>
                                <th>Patente de Comercio</th>
                                <td>${datos.patenteComercio}</td>
                            </tr>
                            <tr>
                                <th>Giro del Negocio</th>
                                <td colspan="3">${datos.giroNegocio}</td>
                            </tr>
                            <tr>
                                <th>Dirección del Negocio</th>
                                <td colspan="3">${datos.direccionNegocio}</td>
                            </tr>
                            <tr>
                                <th>Tipo de Local</th>
                                <td>${datos.tipoLocal}</td>
                                <th>Pago Mensual del Local</th>
                                <td>Q ${datos.pagoMensualLocal}</td>
                            </tr>
                            <tr>
                                <th>Tiempo de Operación</th>
                                <td>${datos.tiempoOperacion}</td>
                                <th>Número de Empleados</th>
                                <td>${datos.numeroEmpleados}</td>
                            </tr>
                            <tr>
                                <th>Ingresos Mensuales</th>
                                <td>Q ${datos.ingresosMensuales}</td>
                                <th>Pago Mensual Negocio</th>
                                <td>Q ${datos.pagoMensualNegocio}</td>
                            </tr>
                            <tr>
                                <th>Estado Físico Interior</th>
                                <td>${datos.estadoFisicoInterior}</td>
                                <th>Estado Físico Exterior</th>
                                <td>${datos.estadoFisicoExterior}</td>
                            </tr>
                        </table>
                        
                        ${datos.proveedores && datos.proveedores.length > 0 ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Proveedores Principales</h3>
                        <table>
                            <tr style="background: #f5f5f5;">
                                <th style="width: 70%;">Nombre del Proveedor</th>
                                <th style="width: 30%;">Monto</th>
                            </tr>
                            ${datos.proveedores.map(p => `
                            <tr>
                                <td>${p.nombre}</td>
                                <td style="text-align: right;">Q ${parseFloat(p.monto || 0).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </table>
                        ` : ''}
                        
                        ${datos.mobiliario && datos.mobiliario.length > 0 ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Mobiliario y Equipo</h3>
                        <table>
                            <tr style="background: #f5f5f5;">
                                <th style="width: 70%;">Descripción</th>
                                <th style="width: 30%;">Valor</th>
                            </tr>
                            ${datos.mobiliario.map(m => `
                            <tr>
                                <td>${m.descripcion}</td>
                                <td style="text-align: right;">Q ${parseFloat(m.valor || 0).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </table>
                        ` : ''}
                        
                        ${datos.mercaderia && datos.mercaderia.length > 0 ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Mercadería en Negocio</h3>
                        <table>
                            <tr style="background: #f5f5f5;">
                                <th style="width: 70%;">Descripción</th>
                                <th style="width: 30%;">Valor</th>
                            </tr>
                            ${datos.mercaderia.map(m => `
                            <tr>
                                <td>${m.descripcion}</td>
                                <td style="text-align: right;">Q ${parseFloat(m.valor || 0).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </table>
                        ` : ''}
                        
                        ${datos.inventario && datos.inventario.length > 0 ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Inventario</h3>
                        <table>
                            <tr style="background: #f5f5f5;">
                                <th style="width: 30%;">Descripción</th>
                                <th style="width: 15%;">Cantidad</th>
                                <th style="width: 18%;">Compra Q</th>
                                <th style="width: 18%;">Venta Q</th>
                                <th style="width: 19%;">Total Venta Q</th>
                            </tr>
                            ${datos.inventario.map(inv => `
                            <tr>
                                <td>${inv.descripcion}</td>
                                <td style="text-align: center;">${inv.cantidad}</td>
                                <td style="text-align: right;">Q ${parseFloat(inv.compra || 0).toFixed(2)}</td>
                                <td style="text-align: right;">Q ${parseFloat(inv.venta || 0).toFixed(2)}</td>
                                <td style="text-align: right;">Q ${parseFloat(inv.total || 0).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </table>
                        ` : ''}
                        
                        ${datos.costoAgua || datos.costoLuz || datos.costoAlquiler || datos.costoTelefono || datos.costoBasura ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Costos Fijos</h3>
                        <table>
                            <tr>
                                <th>Agua</th>
                                <td>Q ${parseFloat(datos.costoAgua || 0).toFixed(2)}</td>
                                <th>Luz</th>
                                <td>Q ${parseFloat(datos.costoLuz || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <th>Alquiler</th>
                                <td>Q ${parseFloat(datos.costoAlquiler || 0).toFixed(2)}</td>
                                <th>Teléfono</th>
                                <td>Q ${parseFloat(datos.costoTelefono || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <th>Basura</th>
                                <td>Q ${parseFloat(datos.costoBasura || 0).toFixed(2)}</td>
                                <th style="background: #fff3cd;"><strong>Total Costos Fijos</strong></th>
                                <td style="background: #fff3cd;"><strong>Q ${parseFloat(datos.totalCostosFijos || 0).toFixed(2)}</strong></td>
                            </tr>
                        </table>
                        ` : ''}
                        
                        ${datos.otrosGastos && datos.otrosGastos.length > 0 ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">Otros Gastos</h3>
                        <table>
                            <tr style="background: #f5f5f5;">
                                <th style="width: 70%;">Descripción</th>
                                <th style="width: 30%;">Monto</th>
                            </tr>
                            ${datos.otrosGastos.map(g => `
                            <tr>
                                <td>${g.descripcion}</td>
                                <td style="text-align: right;">Q ${parseFloat(g.monto || 0).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </table>
                        ` : ''}
                        
                        ${datos.totalVentasMes || datos.costoTotalMes || datos.utilidadNeta ? `
                        <h3 style="margin-top: 15px; font-size: 13px; color: #333;">📊 Resumen Financiero</h3>
                        <table>
                            <tr style="background: #e3f2fd;">
                                <th style="width: 70%;">Total Ventas en el Mes</th>
                                <td style="width: 30%; text-align: right; font-weight: bold;">Q ${parseFloat(datos.totalVentasMes || 0).toFixed(2)}</td>
                            </tr>
                            <tr style="background: #ffebee;">
                                <th>Costo Total en el Mes</th>
                                <td style="text-align: right; font-weight: bold;">Q ${parseFloat(datos.costoTotalMes || 0).toFixed(2)}</td>
                            </tr>
                            <tr style="background: #c8e6c9;">
                                <th style="font-size: 14px;">💰 <strong>Utilidad Neta del Negocio</strong></th>
                                <td style="text-align: right; font-size: 14px; font-weight: bold; color: #2e7d32;">Q ${parseFloat(datos.utilidadNeta || 0).toFixed(2)}</td>
                            </tr>
                        </table>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${datos.nombreEmpresa ? `
                    <div class="section">
                        <h2>💼 RELACIÓN DE DEPENDENCIA / EMPLEO</h2>
                        <table>
                            <tr>
                                <th>Nombre de la Empresa</th>
                                <td colspan="3">${datos.nombreEmpresa}</td>
                            </tr>
                            <tr>
                                <th>Dirección de la Empresa</th>
                                <td colspan="3">${datos.direccionEmpresa}</td>
                            </tr>
                            <tr>
                                <th>Afiliado al IGSS</th>
                                <td>${datos.igss}</td>
                                <th>Teléfono Empresa</th>
                                <td>${datos.telefonoEmpresa}</td>
                            </tr>
                            <tr>
                                <th>Puesto de Trabajo</th>
                                <td>${datos.puestoTrabajo}</td>
                                <th>Salario</th>
                                <td>Q ${datos.salario}</td>
                            </tr>
                            <tr>
                                <th>Fecha de Ingreso</th>
                                <td colspan="3">${datos.fechaIngreso}</td>
                            </tr>
                        </table>
                    </div>
                    ` : ''}
                    
                    
                    ${datos.observacionesGenerales || datos.croquisViviendaObservaciones || datos.verificador ? `
                    <div class="section">
                        <h2>📝 VERIFICACIÓN Y OBSERVACIONES</h2>
                        <table>
                            ${datos.verificador ? `<tr>
                                <th>Verificador</th>
                                <td colspan="3">${datos.verificador}</td>
                            </tr>` : ''}
                            ${datos.observacionesGenerales ? `<tr>
                                <th>Observaciones Generales</th>
                                <td colspan="3">${datos.observacionesGenerales}</td>
                            </tr>` : ''}
                            ${datos.croquisViviendaObservaciones ? `<tr>
                                <th>Observaciones del Croquis</th>
                                <td colspan="3">${datos.croquisViviendaObservaciones}</td>
                            </tr>` : ''}
                        </table>
                    </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            ${croquisViviendaHTML}
                        </div>
                        <div>
                            ${croquisUbicacionHTML}
                        </div>
                    </div>
                    
                    ${mapaHTML}
                    
                    <!-- SECCIÓN DE FIRMAS (en la misma página que el mapa) -->
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 14px; color: ${colorPrimario}; margin-bottom: 15px; font-weight: bold;">✍️ Autorizaciones</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="text-align: center;">
                                <p style="margin-bottom: 5px; font-size: 12px; font-weight: bold; color: #333;">Autorización del Cliente</p>
                                <p style="margin-bottom: 10px; font-size: 10px; color: #666;">
                                    ${datos.tipoAutorizacion === 'Firma' ? '✍️ Firma' : datos.tipoAutorizacion === 'Huella Dactilar' ? '👆 Huella Dactilar' : datos.tipoAutorizacion === 'No Autorizó' ? '❌ No Autorizó' : 'Firma'}
                                </p>
                                ${datos.tipoAutorizacion === 'No Autorizó' ? `
                                <div style="border: 2px solid #ff5252; padding: 8px; background: #ffebee; min-height: 120px; display: flex; align-items: center; justify-content: center; text-align: center;">
                                    <div>
                                        <p style="font-size: 14px; font-weight: bold; color: #d32f2f; margin-bottom: 8px;">❌ NO AUTORIZÓ</p>
                                        <p style="font-size: 10px; color: #666; margin: 0;">${datos.motivoNoAutorizo || 'Sin motivo especificado'}</p>
                                    </div>
                                </div>
                                ` : signatureImg ? `
                                <div style="border: 2px solid #ddd; padding: 8px; background: white; min-height: 120px; display: flex; align-items: center; justify-content: center;">
                                    <img src="${signatureImg}" style="max-width: 100%; max-height: 120px; object-fit: contain;">
                                </div>
                                ` : '<div style="border: 2px solid #ddd; padding: 8px; background: white; min-height: 120px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 11px;">Sin autorización</div>'}
                                <div style="margin-top: 20px; border-top: 2px solid #333; padding-top: 5px; font-size: 11px;">
                                    <strong>${datos.nombrePropietario || '_________________________'}</strong><br>
                                    <small style="font-size: 10px;">Nombre del Cliente</small>
                                </div>
                            </div>
                            
                            <div style="text-align: center;">
                                <p style="margin-bottom: 5px; font-size: 12px; font-weight: bold; color: #333;">Firma del Verificador</p>
                                <p style="margin-bottom: 10px; font-size: 10px; color: #666;">
                                    ✍️ Firma
                                </p>
                                ${verifierSignatureImg ? `
                                <div style="border: 2px solid #ddd; padding: 8px; background: white; min-height: 120px; display: flex; align-items: center; justify-content: center;">
                                    <img src="${verifierSignatureImg}" style="max-width: 100%; max-height: 120px; object-fit: contain;">
                                </div>
                                ` : '<div style="border: 2px solid #ddd; padding: 8px; background: white; min-height: 120px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 11px;">Sin firma</div>'}
                                <div style="margin-top: 20px; border-top: 2px solid #333; padding-top: 5px; font-size: 11px;">
                                    <strong>${datos.verificador || '_________________________'}</strong><br>
                                    <small style="font-size: 10px;">Nombre del Verificador</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${fotosHTML}
                    
                    <!-- CARTA PRESTA EXPRESS EN PÁGINA SEPARADA -->
                    <div class="carta-container" style="position: relative; width: 794px; height: 1123px; margin: 0 auto; page-break-before: always;">
                        <img src="https://live.staticflickr.com/65535/54854215087_71490738ce_b.jpg" 
                             class="carta-img"
                             style="width: 794px; height: 1123px; display: block; position: absolute; top: 0; left: 0;"
                             crossorigin="anonymous">
                        
                        <!-- Sobreponer NOMBRE DEL PROPIETARIO -->
                        <div class="texto-sobrepuesto" style="position: absolute; top: 399px; left: 278px; font-size: 12px; font-weight: bold;">
                            ${datos.nombrePropietario || ' '}
                        </div>
                        
                        <!-- Sobreponer CUI/DPI -->
                        <div class="texto-sobrepuesto" style="position: absolute; top: 421px; left: 413px; font-size: 11px; font-weight: bold;">
                            ${datos.cui || ' '}
                        </div>
                        
                        <!-- Sobreponer FECHA -->
                        <div class="texto-sobrepuesto" style="position: absolute; top: 741px; left: 222px; font-size: 11px; font-weight: bold;">
                            ${fechaCorta || ' '}
                        </div>
                        
                        <!-- Sobreponer FIRMA DEL CLIENTE / HUELLA / NO AUTORIZÓ -->
                        ${datos.tipoAutorizacion === 'No Autorizó' ? `
                        <div style="position: absolute; top: 820px; left: 159px; width: 180px; text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; color: #d32f2f; margin-bottom: 5px;">❌ NO AUTORIZÓ</div>
                            <div style="font-size: 9px; color: #666; line-height: 1.2;">${datos.motivoNoAutorizo || 'Sin motivo'}</div>
                        </div>
                        ` : datos.tipoAutorizacion === 'Huella Dactilar' ? `
                        <div style="position: absolute; top: 820px; left: 198px; width: 180px; text-align: center;">
                            <div style="font-size: 10px; font-weight: bold; color: ${colorPrimario}; margin-bottom: 3px;">👆 HUELLA DACTILAR</div>
                            ${signatureImg ? `
                            <div style="width: 180px; height: 80px; border: 2px solid #ddd; background: white; display: flex; align-items: center; justify-content: center;">
                                <img src="${signatureImg}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                            </div>
                            ` : ''}
                        </div>
                        ` : signatureImg ? `
                        <div style="position: absolute; top: 820px; left: 194px; width: 150px; height: 70px;">
                            <img src="${signatureImg}" style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        ` : ''}
                    </div>
                    
                    
                    <div class="no-print" style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;">
                        <button onclick="window.print()" style="padding: 15px 35px; background: #FF6500; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-right: 15px; box-shadow: 0 2px 10px rgba(255,101,0,0.3);">
                            🖨️ Imprimir / Guardar como PDF
                        </button>
                        <button onclick="window.close()" style="padding: 15px 35px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                            ✖️ Cerrar
                        </button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            console.log('✅ PDF generado exitosamente. Revisa la consola para ver los datos capturados.');
            
            printWindow.document.close();
        }

        // Función original para generar PDF con jsPDF (sin mapa)
        async function generarPDF() {
            // Debug: mostrar información capturada
            console.log('Generando PDF...');
            console.log('Propietario:', document.getElementById('nombrePropietario')?.value);
            console.log('CUI:', document.getElementById('cui')?.value);
            console.log('Teléfono:', document.getElementById('telefonoCelular')?.value);
            console.log('Monto:', document.getElementById('montoSolicitado')?.value);
            console.log('Fotos en DOM:', document.querySelectorAll('#photoPreview img').length);
            console.log('Fotos en app:', window.app?.photos?.length || 0);
            console.log('Mapa GPS:', ubicacionActual ? 'Sí registrado' : 'No disponible');
            
            // Verificar que todos los campos principales tengan valor
            const camposRequeridos = [
                'nombrePropietario', 'cui', 'telefonoCelular', 'montoSolicitado', 
                'direccion', 'nombreNegocio', 'giroNegocio'
            ];
            
            console.log('Verificación de campos:');
            camposRequeridos.forEach(campo => {
                const elemento = document.getElementById(campo);
                const valor = elemento?.value || '';
                console.log(`${campo}: '${valor}' (elemento existe: ${!!elemento})`);
            });
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Configuración del documento
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let yPosition = margin;
            
            // Función auxiliar para agregar texto con salto de línea automático
            function addText(text, x, y, maxWidth, fontSize = 10, fontStyle = 'normal') {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, fontStyle);
                
                if (typeof text !== 'string') text = String(text || '');
                
                const lines = doc.splitTextToSize(text, maxWidth);
                doc.text(lines, x, y);
                return y + (lines.length * fontSize * 0.4);
            }
            
            // Función para agregar una nueva página si es necesario
            function checkPage(requiredSpace) {
                if (yPosition + requiredSpace > pageHeight - margin - 20) {
                    doc.addPage();
                    yPosition = margin;
                }
            }
            
            // Funciones para obtener datos dinámicos
            function getInventarioInfo() {
                const productos = [];
                document.querySelectorAll('.inventario-item').forEach(item => {
                    const descripcion = item.querySelector('input[name="productoDescripcion[]"]')?.value;
                    const cantidad = item.querySelector('input[name="productoCantidad[]"]')?.value;
                    const compra = item.querySelector('input[name="productoCompra[]"]')?.value;
                    const venta = item.querySelector('input[name="productoVenta[]"]')?.value;
                    if (descripcion) {
                        productos.push({ descripcion, cantidad: cantidad || 0, compra: compra || 0, venta: venta || 0 });
                    }
                });
                return productos;
            }
            
            function getProveedoresInfo() {
                const proveedores = [];
                document.querySelectorAll('.proveedor-item').forEach(item => {
                    const nombre = item.querySelector('input[name="proveedor[]"]')?.value;
                    const monto = item.querySelector('input[name="montoProveedor[]"]')?.value;
                    if (nombre) {
                        proveedores.push({ nombre, monto: monto || 0 });
                    }
                });
                return proveedores;
            }
            
            function getMobiliarioInfo() {
                const mobiliario = [];
                document.querySelectorAll('.mobiliario-item').forEach(item => {
                    const descripcion = item.querySelector('input[name="mobiliario[]"]')?.value;
                    const valor = item.querySelector('input[name="valorMobiliario[]"]')?.value;
                    if (descripcion) {
                        mobiliario.push({ descripcion, valor: valor || 0 });
                    }
                });
                return mobiliario;
            }
            
            function getMercaderiaInfo() {
                const mercaderia = [];
                document.querySelectorAll('.mercaderia-item').forEach(item => {
                    const descripcion = item.querySelector('input[name="mercaderia[]"]')?.value;
                    const valor = item.querySelector('input[name="valorMercaderia[]"]')?.value;
                    if (descripcion) {
                        mercaderia.push({ descripcion, valor: valor || 0 });
                    }
                });
                return mercaderia;
            }
            
            function getOtrosGastosInfo() {
                const gastos = [];
                document.querySelectorAll('.otros-gastos-item').forEach(item => {
                    const descripcion = item.querySelector('input[name="descripcionGasto[]"]')?.value;
                    const monto = item.querySelector('input[name="montoGasto[]"]')?.value;
                    if (descripcion) {
                        gastos.push({ descripcion, monto: monto || 0 });
                    }
                });
                return gastos;
            }
            
            // Encabezado del documento con diseño elegante
            doc.setFillColor(255, 101, 0);
            doc.rect(0, 0, pageWidth, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('FORMULARIO DE VERIFICACIÓN', pageWidth / 2, 12, { align: 'center' });
            doc.setFontSize(14);
            doc.text('SISTEMA DE COBROS', pageWidth / 2, 22, { align: 'center' });
            
            // Línea decorativa
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(margin, 32, pageWidth - margin, 32);
            
            yPosition = 40;
            doc.setTextColor(0, 0, 0);
            
            // Información del cliente
            checkPage(25);
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
            doc.setDrawColor(255, 101, 0);
            doc.setLineWidth(2);
            doc.line(margin, yPosition - 2, margin, yPosition + 4);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 101, 0);
            doc.text('INFORMACIÓN DEL CLIENTE', margin + 3, yPosition + 2);
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            // Obtener TODOS los datos del formulario al principio
            const nombrePropietario = document.getElementById('nombrePropietario')?.value || '';
            const personaAtiende = document.getElementById('personaAtiende')?.value || '';
            const cui = document.getElementById('cui')?.value || '';
            const telefono = document.getElementById('telefonoCelular')?.value || '';
            const email = document.getElementById('emailContacto')?.value || '';
            const direccion = document.getElementById('direccion')?.value || '';
            const departamento = document.getElementById('departamento')?.value || '';
            const municipio = document.getElementById('municipio')?.value || '';
            const montoSolicitado = document.getElementById('montoSolicitado')?.value || '';
            const parentesco = document.getElementById('parentesco')?.value || '';
            const tiempoResidencia = document.getElementById('tiempoResidencia')?.value || '';
            const contadorFisico = document.getElementById('contadorFisico')?.value || '';
            const quienesViven = document.getElementById('quienesViven')?.value || '';
            const dimensionesInmueble = document.getElementById('dimensionesInmueble')?.value || '';
            const destinoCredito = document.getElementById('destinoCredito')?.value || '';
            const formaAdquisicion = document.getElementById('formaAdquisicion')?.value || '';
            
            // Información laboral/empresa
            const nombreEmpresa = document.getElementById('nombreEmpresa')?.value || '';
            const direccionEmpresa = document.getElementById('direccionEmpresa')?.value || '';
            const puestoTrabajo = document.getElementById('puestoTrabajo')?.value || '';
            const telefonoEmpresa = document.getElementById('telefonoEmpresa')?.value || '';
            
            // Obtener servicios seleccionados
            const serviciosDisponibles = [];
            document.querySelectorAll('input[name="servicios"]:checked').forEach(cb => {
                serviciosDisponibles.push(cb.value);
            });
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            yPosition = addText(`Propietario: ${nombrePropietario}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Monto Solicitado: Q${montoSolicitado}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Persona que Atiende: ${personaAtiende}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`CUI: ${cui}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Parentesco: ${parentesco}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Teléfono: ${telefono}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Tiempo de Residencia: ${tiempoResidencia}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Contador: ${contadorFisico}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Dirección: ${direccion}`, margin, yPosition, contentWidth, 8);
            yPosition = addText(`Dimensiones: ${dimensionesInmueble}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Destino Crédito: ${destinoCredito}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Forma Adquisición: ${formaAdquisicion}`, margin, yPosition, contentWidth, 8);
            if (serviciosDisponibles.length > 0) {
                yPosition = addText(`Servicios: ${serviciosDisponibles.join(', ')}`, margin, yPosition, contentWidth, 8);
            }
            if (quienesViven) {
                yPosition = addText(`Quienes Viven: ${quienesViven}`, margin, yPosition, contentWidth, 8);
            }
            if (departamento) {
                yPosition = addText(`Depto: ${departamento}`, margin, yPosition, contentWidth / 2, 8);
            }
            if (municipio) {
                yPosition = addText(`Municipio: ${municipio}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            }
            yPosition += 5;
            
            // Información laboral si existe
            if (nombreEmpresa || puestoTrabajo) {
                checkPage(20);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('INFORMACIÓN LABORAL', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                doc.setFontSize(8);
                if (nombreEmpresa) {
                    yPosition = addText(`Empresa: ${nombreEmpresa}`, margin, yPosition, contentWidth / 2, 8);
                }
                if (puestoTrabajo) {
                    yPosition = addText(`Puesto: ${puestoTrabajo}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
                }
                if (direccionEmpresa) {
                    yPosition = addText(`Dirección Empresa: ${direccionEmpresa}`, margin, yPosition, contentWidth, 8);
                }
                if (telefonoEmpresa) {
                    yPosition = addText(`Teléfono Empresa: ${telefonoEmpresa}`, margin, yPosition, contentWidth / 2, 8);
                }
                yPosition += 5;
            }
            
            // Información de la vivienda
            checkPage(20);
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
            doc.setDrawColor(255, 101, 0);
            doc.setLineWidth(2);
            doc.line(margin, yPosition - 2, margin, yPosition + 4);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 101, 0);
            doc.text('CARACTERÍSTICAS DE LA VIVIENDA', margin + 3, yPosition + 2);
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            const tipoVivienda = document.querySelector('input[name="tipoVivienda"]:checked')?.value || '';
            const tipoTecho = document.getElementById('materialTecho')?.value || '';
            const tipoPared = document.getElementById('materialParedes')?.value || '';
            const tipoPiso = document.getElementById('materialPiso')?.value || '';
            const habitaciones = document.getElementById('numeroHabitaciones')?.value || '';
            const sanitarios = document.getElementById('numeroBanos')?.value || '';
            const condicionViviendaElem = document.querySelector('input[name="condicionVivienda"]:checked');
            const condicionVivienda = condicionViviendaElem ? condicionViviendaElem.value : '';
            
            doc.setFontSize(8);
            yPosition = addText(`Tipo: ${tipoVivienda}`, margin, yPosition, contentWidth / 3, 8);
            yPosition = addText(`Habitaciones: ${habitaciones}`, margin + contentWidth / 3, yPosition - 3, contentWidth / 3, 8);
            yPosition = addText(`Baños: ${sanitarios}`, margin + (contentWidth * 2 / 3), yPosition - 3, contentWidth / 3, 8);
            yPosition = addText(`Techo: ${tipoTecho}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Pared: ${tipoPared}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Piso: ${tipoPiso}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Condición: ${condicionVivienda}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition += 5;
            
            // Información del negocio
            checkPage(20);
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
            doc.setDrawColor(255, 101, 0);
            doc.setLineWidth(2);
            doc.line(margin, yPosition - 2, margin, yPosition + 4);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 101, 0);
            doc.text('INFORMACIÓN DEL NEGOCIO', margin + 3, yPosition + 2);
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            const nombreNegocio = document.getElementById('nombreNegocio')?.value || '';
            const giroNegocio = document.getElementById('giroNegocio')?.value || '';
            const tipoLocal = document.querySelector('input[name="tipoLocal"]:checked')?.value || '';
            const tiempoOperacion = document.getElementById('tiempoOperacion')?.value || '';
            const numeroEmpleados = document.getElementById('numeroEmpleados')?.value || '';
            const ingresosMensuales = document.getElementById('ingresosMensuales')?.value || '';
            const direccionNegocio = document.getElementById('direccionNegocio')?.value || '';
            const patenteComercio = document.getElementById('patenteComercio')?.value || '';
            
            doc.setFontSize(8);
            yPosition = addText(`Nombre: ${nombreNegocio}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Giro: ${giroNegocio}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Tipo Local: ${tipoLocal}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Patente: ${patenteComercio}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Tiempo Operación: ${tiempoOperacion}`, margin, yPosition, contentWidth / 2, 8);
            yPosition = addText(`Empleados: ${numeroEmpleados}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            yPosition = addText(`Ingresos Mensuales: Q${ingresosMensuales}`, margin, yPosition, contentWidth / 2, 8);
            if (direccionNegocio) {
                yPosition = addText(`Dirección Negocio: ${direccionNegocio}`, margin, yPosition, contentWidth, 8);
            }
            
            // Estado físico del negocio
            const estadoInterior = document.querySelector('input[name="estadoFisicoInterior"]:checked')?.value || '';
            const estadoExterior = document.querySelector('input[name="estadoFisicoExterior"]:checked')?.value || '';
            
            if (estadoInterior || estadoExterior) {
                yPosition = addText(`Estado Interior: ${estadoInterior}`, margin, yPosition, contentWidth / 2, 8);
                yPosition = addText(`Estado Exterior: ${estadoExterior}`, margin + contentWidth / 2, yPosition - 3, contentWidth / 2, 8);
            }
            yPosition += 5;
            
            // Resumen financiero
            checkPage(20);
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
            doc.setDrawColor(255, 101, 0);
            doc.setLineWidth(2);
            doc.line(margin, yPosition - 2, margin, yPosition + 4);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 101, 0);
            doc.text('ANÁLISIS FINANCIERO', margin + 3, yPosition + 2);
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            const totalVentas = document.getElementById('totalVentasMes')?.value || '0';
            const costoTotal = document.getElementById('costoTotalMes')?.value || '0';
            const utilidadNeta = document.getElementById('utilidadNeta')?.value || '0';
            const totalCostosFijos = document.getElementById('totalCostosFijos')?.value || '0';
            
            // Costos fijos individuales
            const costoAgua = document.getElementById('costoAgua')?.value || '0';
            const costoLuz = document.getElementById('costoLuz')?.value || '0';
            const costoAlquiler = document.getElementById('costoAlquiler')?.value || '0';
            const costoTelefono = document.getElementById('costoTelefono')?.value || '0';
            const costoBasura = document.getElementById('costoBasura')?.value || '0';
            
            doc.setFontSize(8);
            yPosition = addText(`Ventas Mensuales: Q ${totalVentas}`, margin, yPosition, contentWidth / 3, 8);
            yPosition = addText(`Costos Totales: Q ${costoTotal}`, margin + contentWidth / 3, yPosition - 3, contentWidth / 3, 8);
            yPosition = addText(`Utilidad Neta: Q ${utilidadNeta}`, margin + (contentWidth * 2 / 3), yPosition - 3, contentWidth / 3, 8);
            
            // Desglose de costos fijos si hay datos
            if (parseFloat(totalCostosFijos) > 0) {
                yPosition += 3;
                doc.setFont(undefined, 'bold');
                yPosition = addText('Desglose Costos Fijos:', margin, yPosition, contentWidth, 7, 'bold');
                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);
                yPosition = addText(`Agua: Q${costoAgua}`, margin, yPosition, contentWidth / 5, 7);
                yPosition = addText(`Luz: Q${costoLuz}`, margin + contentWidth / 5, yPosition - 2.5, contentWidth / 5, 7);
                yPosition = addText(`Alquiler: Q${costoAlquiler}`, margin + contentWidth * 2 / 5, yPosition - 2.5, contentWidth / 5, 7);
                yPosition = addText(`Teléfono: Q${costoTelefono}`, margin + contentWidth * 3 / 5, yPosition - 2.5, contentWidth / 5, 7);
                yPosition = addText(`Basura: Q${costoBasura}`, margin + contentWidth * 4 / 5, yPosition - 2.5, contentWidth / 5, 7);
            }
            yPosition += 5;
            
            // Obtener información detallada del negocio
            const productos = getInventarioInfo();
            const proveedores = getProveedoresInfo();
            const mobiliario = getMobiliarioInfo();
            const mercaderia = getMercaderiaInfo();
            const otrosGastos = getOtrosGastosInfo();
            
            // Sección de Inventario
            if (productos.length > 0) {
                checkPage(30);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('INVENTARIO', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                // Encabezados de tabla
                doc.setFontSize(7);
                doc.setFont(undefined, 'bold');
                doc.text('Descripción', margin, yPosition);
                doc.text('Cant.', margin + 60, yPosition);
                doc.text('Compra', margin + 80, yPosition);
                doc.text('Venta', margin + 105, yPosition);
                doc.text('Total', margin + 130, yPosition);
                yPosition += 4;
                
                doc.setFont(undefined, 'normal');
                productos.slice(0, 8).forEach(producto => {
                    const total = (parseFloat(producto.cantidad) || 0) * (parseFloat(producto.venta) || 0);
                    doc.text(producto.descripcion.substring(0, 25), margin, yPosition);
                    doc.text(String(producto.cantidad), margin + 60, yPosition);
                    doc.text(`Q${producto.compra}`, margin + 80, yPosition);
                    doc.text(`Q${producto.venta}`, margin + 105, yPosition);
                    doc.text(`Q${total.toFixed(2)}`, margin + 130, yPosition);
                    yPosition += 3;
                });
                yPosition += 5;
            }
            
            // Sección de Proveedores
            if (proveedores.length > 0) {
                checkPage(20);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('PROVEEDORES', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                doc.setFontSize(8);
                proveedores.slice(0, 5).forEach(proveedor => {
                    yPosition = addText(`• ${proveedor.nombre}: Q${proveedor.monto}`, margin, yPosition, contentWidth, 7);
                });
                yPosition += 5;
            }
            
            // Sección de Mobiliario y Equipo
            if (mobiliario.length > 0) {
                checkPage(20);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('MOBILIARIO Y EQUIPO', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                doc.setFontSize(8);
                mobiliario.slice(0, 5).forEach(item => {
                    yPosition = addText(`• ${item.descripcion}: Q${item.valor}`, margin, yPosition, contentWidth, 7);
                });
                yPosition += 5;
            }
            
            // Sección de Mercadería
            if (mercaderia.length > 0) {
                checkPage(20);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('MERCADERÍA EN NEGOCIO', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                doc.setFontSize(8);
                mercaderia.slice(0, 5).forEach(item => {
                    yPosition = addText(`• ${item.descripcion}: Q${item.valor}`, margin, yPosition, contentWidth, 7);
                });
                yPosition += 5;
            }
            
            // Sección de Otros Gastos
            if (otrosGastos.length > 0) {
                checkPage(15);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('OTROS GASTOS', margin + 3, yPosition + 2);
                yPosition += 8;
                doc.setTextColor(0, 0, 0);
                
                doc.setFontSize(8);
                otrosGastos.slice(0, 5).forEach(gasto => {
                    yPosition = addText(`• ${gasto.descripcion}: Q${gasto.monto}`, margin, yPosition, contentWidth, 7);
                });
                yPosition += 5;
            }
            
            // Agregar fotografías si existen
            const appInstance = window.app;
            const fotos = (appInstance && appInstance.photos) ? appInstance.photos : [];
            
            if (fotos.length > 0) {
                checkPage(30);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('EVIDENCIA FOTOGRÁFICA', margin + 3, yPosition + 2);
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
                
                let xPhoto = margin;
                let photoCount = 0;
                const maxPhotosPerRow = 4;
                const photoWidth = (contentWidth - 30) / maxPhotosPerRow;
                const photoHeight = photoWidth * 0.6;
                
                // Procesar fotos de la app
                for (let fotoData of fotos) {
                    if (photoCount % maxPhotosPerRow === 0 && photoCount > 0) {
                        yPosition += photoHeight + 5;
                        xPhoto = margin;
                        checkPage(photoHeight + 10);
                    }
                    
                    try {
                        const imgData = fotoData.data || fotoData;
                        doc.addImage(imgData, 'JPEG', xPhoto, yPosition, photoWidth, photoHeight);
                        xPhoto += photoWidth + 5;
                        photoCount++;
                    } catch (e) {
                        console.error('Error al procesar imagen:', e);
                    }
                }
                
                if (photoCount > 0) {
                    yPosition += photoHeight + 8;
                }
            }
            
            // Agregar croquis si existen
            const canvasVivienda = document.getElementById('sketchCanvas');
            const canvasUbicacion = document.getElementById('locationCanvas');
            
            if (canvasVivienda || canvasUbicacion) {
                checkPage(50);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('CROQUIS Y DIAGRAMAS', margin + 3, yPosition + 2);
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
                
                if (canvasVivienda && canvasUbicacion) {
                    // Ambos croquis lado a lado
                    try {
                        const imgDataVivienda = canvasVivienda.toDataURL('image/png');
                        const imgDataUbicacion = canvasUbicacion.toDataURL('image/png');
                        
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.text('VIVIENDA', margin + 30, yPosition);
                        doc.text('UBICACIÓN', margin + 105, yPosition);
                        
                        doc.addImage(imgDataVivienda, 'PNG', margin, yPosition + 2, 70, 45);
                        doc.addImage(imgDataUbicacion, 'PNG', margin + 75, yPosition + 2, 70, 45);
                        yPosition += 50;
                    } catch (e) {
                        console.error('Error al procesar croquis:', e);
                    }
                } else if (canvasVivienda) {
                    try {
                        const imgData = canvasVivienda.toDataURL('image/png');
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.text('CROQUIS DE VIVIENDA', margin, yPosition);
                        doc.addImage(imgData, 'PNG', margin, yPosition + 2, 80, 50);
                        yPosition += 55;
                    } catch (e) {
                        console.error('Error al procesar croquis de vivienda:', e);
                    }
                } else if (canvasUbicacion) {
                    try {
                        const imgData = canvasUbicacion.toDataURL('image/png');
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.text('CROQUIS DE UBICACIÓN', margin, yPosition);
                        doc.addImage(imgData, 'PNG', margin, yPosition + 2, 80, 50);
                        yPosition += 55;
                    } catch (e) {
                        console.error('Error al procesar croquis de ubicación:', e);
                    }
                }
                
                // Agregar información de ubicación GPS si está disponible
                if (ubicacionActual) {
                    checkPage(100);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 101, 0);
                    doc.text('📍 UBICACIÓN GPS', margin, yPosition);
                    yPosition += 5;
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Latitud: ${ubicacionActual.latitud.toFixed(6)}`, margin, yPosition);
                    doc.text(`Longitud: ${ubicacionActual.longitud.toFixed(6)}`, margin + 60, yPosition);
                    yPosition += 4;
                    doc.text(`Precisión: ${ubicacionActual.precision.toFixed(0)} metros`, margin, yPosition);
                    yPosition += 8;
                    
                    // Crear HTML del mapa como en tu otro formulario
                    const mapaHTML = `
                        <div style="margin: 20px 0; text-align: center; page-break-inside: avoid;">
                            <div style="width: 100%; height: 300px; border: 2px solid #FF6500; background-color: #f0f0f0; position: relative;">
                                <iframe 
                                    width="100%" 
                                    height="300" 
                                    frameborder="0" 
                                    style="border:0" 
                                    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${ubicacionActual.latitud},${ubicacionActual.longitud}&zoom=18&maptype=satellite"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        </div>
                    `;
                    
                    // Guardar el HTML del mapa para usar en exportación HTML
                    ubicacionActual.mapaHTML = mapaHTML;
                    
                    // Agregar imagen del mapa
                    const mapWidth = contentWidth;
                    const mapHeight = 80;
                    
                    if (ubicacionActual.mapaImagen) {
                        try {
                            console.log('Agregando imagen del mapa al PDF...');
                            doc.addImage(ubicacionActual.mapaImagen, 'JPEG', margin, yPosition, mapWidth, mapHeight);
                            console.log('✅ Mapa agregado al PDF');
                            yPosition += mapHeight + 5;
                        } catch (e) {
                            console.error('Error al agregar imagen del mapa al PDF:', e);
                            // Intentar con la URL directa si está disponible
                            if (ubicacionActual.mapaImagenDirecta) {
                                try {
                                    doc.addImage(ubicacionActual.mapaImagenDirecta, 'JPEG', margin, yPosition, mapWidth, mapHeight);
                                    console.log('✅ Mapa agregado desde URL directa');
                                    yPosition += mapHeight + 5;
                                } catch (e2) {
                                    console.error('Error con URL directa:', e2);
                                    yPosition += 5;
                                }
                            } else {
                                yPosition += 5;
                            }
                        }
                    } else if (ubicacionActual.mapaImagenDirecta) {
                        // Intentar agregar directamente desde URL
                        try {
                            console.log('Intentando agregar mapa desde URL...');
                            doc.addImage(ubicacionActual.mapaImagenDirecta, 'JPEG', margin, yPosition, mapWidth, mapHeight);
                            console.log('✅ Mapa agregado desde URL');
                            yPosition += mapHeight + 5;
                        } catch (e) {
                            console.error('Error al agregar mapa desde URL:', e);
                            yPosition += 5;
                        }
                    }
                    
                    // Agregar enlace a Google Maps
                    const googleMapsUrl = `https://www.google.com/maps?q=${ubicacionActual.latitud},${ubicacionActual.longitud}`;
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 255);
                    doc.textWithLink('🔗 Ver ubicación en Google Maps', margin, yPosition, { url: googleMapsUrl });
                    doc.setTextColor(0, 0, 0);
                    yPosition += 8;
                }
            }
            
            // Agregar firmas si existen
            const canvasFirma = document.getElementById('signatureCanvas');
            const canvasFirmaVerificador = document.getElementById('verifierSignatureCanvas');
            
            if (canvasFirma || canvasFirmaVerificador) {
                checkPage(40);
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 2, contentWidth, 6, 'F');
                doc.setDrawColor(255, 101, 0);
                doc.setLineWidth(2);
                doc.line(margin, yPosition - 2, margin, yPosition + 4);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 101, 0);
                doc.text('FIRMAS DE AUTORIZACIÓN', margin + 3, yPosition + 2);
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
                
                if (canvasFirma && canvasFirmaVerificador) {
                    // Ambas firmas lado a lado
                    try {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.text('CLIENTE', margin + 25, yPosition);
                        doc.text('VERIFICADOR', margin + 105, yPosition);
                        
                        const imgData = canvasFirma.toDataURL('image/png');
                        const imgDataVerificador = canvasFirmaVerificador.toDataURL('image/png');
                        
                        doc.addImage(imgData, 'PNG', margin, yPosition + 2, 70, 25);
                        doc.addImage(imgDataVerificador, 'PNG', margin + 75, yPosition + 2, 70, 25);
                        
                        // Líneas para nombres
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPosition + 30, margin + 65, yPosition + 30);
                        doc.line(margin + 75, yPosition + 30, margin + 140, yPosition + 30);
                        
                        yPosition += 35;
                    } catch (e) {
                        console.error('Error al procesar firmas:', e);
                    }
                } else if (canvasFirma) {
                    try {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.text('FIRMA DEL CLIENTE', margin, yPosition);
                        const imgData = canvasFirma.toDataURL('image/png');
                        doc.addImage(imgData, 'PNG', margin, yPosition + 2, 80, 30);
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPosition + 35, margin + 75, yPosition + 35);
                        yPosition += 40;
                    } catch (e) {
                        console.error('Error al procesar firma del cliente:', e);
                    }
                } else if (canvasFirmaVerificador) {
                    try {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.text('FIRMA DEL VERIFICADOR', margin, yPosition);
                        const imgDataVerificador = canvasFirmaVerificador.toDataURL('image/png');
                        doc.addImage(imgDataVerificador, 'PNG', margin, yPosition + 2, 80, 30);
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPosition + 35, margin + 75, yPosition + 35);
                        yPosition += 40;
                    } catch (e) {
                        console.error('Error al procesar firma del verificador:', e);
                    }
                }
            }
            
            // Pie de página profesional
            checkPage(25);
            yPosition = Math.max(yPosition + 10, pageHeight - 35);
            
            // Línea decorativa superior
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition - 5, pageWidth - margin, yPosition - 5);
            
            // Información adicional
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            const fecha = new Date().toLocaleDateString('es-GT', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            doc.text(`Documento generado el ${fecha}`, margin, yPosition);
            
            // Banner inferior
            doc.setFillColor(255, 101, 0);
            doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('DOCUMENTO OFICIAL DE VERIFICACIÓN', pageWidth / 2, pageHeight - 7, { align: 'center' });
            doc.setFontSize(6);
            doc.text('Este documento es válido únicamente con las firmas correspondientes', pageWidth / 2, pageHeight - 3, { align: 'center' });
            
            // Agregar nueva página con imagen de Flickr solamente
            doc.addPage();
            yPosition = margin;
            
            // Encabezado de la página adicional
            doc.setFillColor(255, 101, 0);
            doc.rect(0, 0, pageWidth, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('DOCUMENTO ANEXO', pageWidth / 2, 12, { align: 'center' });
            doc.setFontSize(14);
            doc.text('INFORMACIÓN COMPLEMENTARIA', pageWidth / 2, 22, { align: 'center' });
            
            // Sin línea decorativa - imagen directamente en la posición indicada
            yPosition = 32;
            doc.setTextColor(0, 0, 0);
            
            // Solo cargar la imagen específica de Flickr
            console.log('Cargando ÚNICAMENTE la imagen de Flickr...');
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    console.log('✓ Imagen de Flickr cargada exitosamente');
                    
                    // Crear canvas para convertir la imagen
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Configurar canvas con las dimensiones de la imagen
                    canvas.width = this.naturalWidth || this.width;
                    canvas.height = this.naturalHeight || this.height;
                    
                    // Dibujar la imagen en el canvas
                    ctx.drawImage(this, 0, 0);
                    
                    // Convertir a base64
                    const imagenBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Calcular dimensiones para que ocupe toda la hoja
                    const imgWidth = pageWidth; // Ancho completo de la página
                    const imgHeight = pageHeight - 80; // Alto disponible desde donde estaba la línea de referencia
                    
                    // Posicionar desde el borde izquierdo, exactamente donde estaba la línea de referencia
                    const xPos = 0;
                    const yPos = 32; // Exactamente donde estaba la línea roja de referencia
                    
                    // Agregar al PDF ocupando toda la página
                    doc.addImage(imagenBase64, 'JPEG', xPos, yPos, imgWidth, imgHeight);
                    
                    console.log('✓ Imagen de Flickr agregada al PDF');
                    
                    // Obtener el nombre del propietario
                    const nombrePropietario = document.getElementById('nombrePropietario')?.value || '';
                    
                    if (nombrePropietario) {
                        console.log('📝 Agregando nombre del propietario:', nombrePropietario);
                        
                        // Obtener las dimensiones originales de la imagen
                        const imgOriginalWidth = this.naturalWidth || this.width;
                        const imgOriginalHeight = this.naturalHeight || this.height;
                        
                        console.log(`📐 Dimensiones originales: ${imgOriginalWidth}x${imgOriginalHeight}`);
                        console.log(`📐 Dimensiones en PDF: ${imgWidth}x${imgHeight}`);
                        
                        // Calcular la escala de la imagen en el PDF
                        const scaleX = imgWidth / imgOriginalWidth;
                        const scaleY = imgHeight / imgOriginalHeight;
                        
                        console.log(`📏 Escalas: X=${scaleX.toFixed(4)}, Y=${scaleY.toFixed(4)}`);
                        
                        // Convertir las coordenadas al sistema del PDF (coordenadas relativas a la imagen)
                        const textX = xPos + (1104 * scaleX);
                        const textY = yPos + (56 * scaleY);
                        const textWidth = 437 * scaleX;
                        
                        console.log(`📍 Posición calculada: X=${textX.toFixed(2)}, Y=${textY.toFixed(2)}`);
                        console.log(`📏 Ancho del área: ${textWidth.toFixed(2)}`);
                        
                        // Verificar si las coordenadas están dentro de los límites del PDF
                        if (textX > 0 && textX < pageWidth && textY > 0 && textY < pageHeight) {
                            console.log('✅ Coordenadas dentro de los límites del PDF');
                        } else {
                            console.log('⚠️ Coordenadas fuera de los límites del PDF');
                            console.log(`Límites: ancho=${pageWidth}, alto=${pageHeight}`);
                        }
                        
                        // ⚙️ CONFIGURACIÓN DE POSICIÓN DEL TEXTO ⚙️
                        // Puedes ajustar estos valores para mover el texto:
                        // textX_pos: Más alto = más a la derecha, más bajo = más a la izquierda
                        // textY_pos: Más alto = más abajo, más bajo = más arriba
                        const textX_pos = 63;  // 📍 CAMBIA ESTE VALOR: posición horizontal (en mm)
                        const textY_pos = 112; // 📍 CAMBIA ESTE VALOR: posición vertical (en mm)
                        
                        console.log(`🎯 Agregando nombre en posición: X=${textX_pos}, Y=${textY_pos}`);
                        
                        // Configurar el texto: solo letras, sin fondo
                        doc.setFontSize(10); // Tamaño más pequeño
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0); // Texto negro
                        
                        // Agregar el texto del nombre sobre la imagen
                        doc.text(nombrePropietario, textX_pos, textY_pos);
                        
                        console.log('✅ Nombre del propietario agregado exitosamente sobre la imagen');
                        console.log(`📍 Coordenadas finales: (${textX.toFixed(2)}, ${textY.toFixed(2)})`);
                    } else {
                        console.log('⚠️ No se encontró nombre del propietario en el formulario');
                    }

                    // 📅 AGREGAR FECHA SOBREPUESTA
                    const fechaVisita = document.getElementById('fechaVisita')?.value;
                    if (fechaVisita) {
                        // ⚙️ CONFIGURACIÓN DE POSICIÓN DE LA FECHA ⚙️
                        // Puedes ajustar estos valores para mover la fecha:
                        const fechaX_pos = 46;  // 📍 CAMBIA ESTE VALOR: posición horizontal de fecha (en mm)
                        const fechaY_pos = 175; // 📍 CAMBIA ESTE VALOR: posición vertical de fecha (en mm)
                        
                        console.log(`📅 Agregando fecha en posición: X=${fechaX_pos}, Y=${fechaY_pos}`);
                        
                        // Formatear la fecha (convertir de YYYY-MM-DD a DD/MM/YYYY)
                        const fechaFormateada = fechaVisita.split('-').reverse().join('/');
                        
                        // Configurar el texto de fecha: mismo estilo que el nombre
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0); // Texto negro
                        
                        // Agregar el texto de la fecha sobre la imagen
                        doc.text(fechaFormateada, fechaX_pos, fechaY_pos);
                        
                        console.log('✅ Fecha agregada exitosamente sobre la imagen:', fechaFormateada);
                    } else {
                        console.log('⚠️ No se encontró fecha en el formulario');
                    }

                    // ✍️ AGREGAR FIRMA DEL CLIENTE SOBREPUESTA
                    const signatureCanvas = document.getElementById('signatureCanvas');
                    if (signatureCanvas) {
                        // Verificar si el canvas tiene contenido (no está vacío)
                        const signatureData = signatureCanvas.toDataURL();
                        
                        // Crear un canvas temporal para verificar si está vacío
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = signatureCanvas.width;
                        tempCanvas.height = signatureCanvas.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        // No es necesario rellenar, comparar con una URL de datos vacía es suficiente
                        const blankData = tempCanvas.toDataURL();
                        
                        if (signatureData !== blankData) {
                            // ⚙️ CONFIGURACIÓN DE POSICIÓN DE LA FIRMA ⚙️
                            // Puedes ajustar estos valores para mover la firma:
                            const firmaX_pos = 39;  // 📍 CAMBIA ESTE VALOR: posición horizontal de firma (en mm)
                            const firmaY_pos = 180;  // 📍 CAMBIA ESTE VALOR: posición vertical de firma (en mm)
                            const firmaAncho = 40;   // 📍 CAMBIA ESTE VALOR: ancho de la firma (en mm)
                            const firmaAlto = 20;    // 📍 CAMBIA ESTE VALOR: alto de la firma (en mm)
                            
                            console.log(`✍️ Agregando firma en posición: X=${firmaX_pos}, Y=${firmaY_pos}`);
                            
                            // Agregar la firma como imagen sobre la imagen de fondo
                            doc.addImage(signatureData, 'PNG', firmaX_pos, firmaY_pos, firmaAncho, firmaAlto);
                            
                            console.log('✅ Firma del cliente agregada exitosamente sobre la imagen');
                        } else {
                            console.log('⚠️ No se encontró firma del cliente (canvas vacío)');
                        }
                    } else {
                        console.log('⚠️ No se encontró canvas de firma del cliente');
                    }

                    // 🆔 AGREGAR DPI/CUI SOBREPUESTO
                    const cuiPropietario = document.getElementById('cui')?.value;
                    if (cuiPropietario) {
                        // ⚙️ CONFIGURACIÓN DE POSICIÓN DEL DPI/CUI ⚙️
                        // Puedes ajustar estos valores para mover el DPI:
                        const dpiX_pos = 103;   // 📍 CAMBIA ESTE VALOR: posición horizontal del DPI (en mm)
                        const dpiY_pos = 117;  // 📍 CAMBIA ESTE VALOR: posición vertical del DPI (en mm)
                        
                        console.log(`🆔 Agregando DPI/CUI en posición: X=${dpiX_pos}, Y=${dpiY_pos}`);
                        
                        // Formatear el CUI agregando guiones para mejor legibilidad
                        const cuiFormateado = cuiPropietario.replace(/(\d{4})(\d{5})(\d{4})/, '$1-$2-$3');
                        
                        // Configurar el texto del DPI: mismo estilo que nombre y fecha
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0); // Texto negro
                        
                        // Agregar solo los números del DPI/CUI sobre la imagen
                        doc.text(cuiFormateado, dpiX_pos, dpiY_pos);
                        
                        console.log('✅ DPI/CUI agregado exitosamente sobre la imagen:', cuiFormateado);
                    } else {
                        console.log('⚠️ No se encontró DPI/CUI en el formulario');
                    }
                    
                    // Finalizar y descargar PDF
                    finalizarPDFUnico();
                    
                } catch (error) {
                    console.error('✗ Error al procesar imagen de Flickr:', error);
                    // Si falla el procesamiento, continuar sin imagen
                    finalizarPDFUnico();
                }
            };
            
            img.onerror = function() {
                console.error('✗ No se pudo cargar la imagen de Flickr');
                console.log('Generando PDF sin imagen adicional...');
                finalizarPDFUnico();
            };
            
            // Función para finalizar el PDF una sola vez
            const finalizarPDFUnico = () => {
                console.log('Finalizando PDF único...');
                
                // Pie de página para la página adicional
                const footerY = pageHeight - 35;
                
                // Línea decorativa superior
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                
                // Información adicional
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-GT', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                doc.text(`Documento generado el ${fecha}`, margin, footerY);
                
                // Banner inferior
                doc.setFillColor(255, 101, 0);
                doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('DOCUMENTO OFICIAL DE VERIFICACIÓN', pageWidth / 2, pageHeight - 7, { align: 'center' });
                doc.setFontSize(6);
                doc.text('Este documento es válido únicamente con las firmas correspondientes', pageWidth / 2, pageHeight - 3, { align: 'center' });
                
                // DESCARGAR EL PDF UNA SOLA VEZ
                const nombreArchivo = `Verificacion_Cobros_${nombrePropietario.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(nombreArchivo);
                
                // Confirmación
                console.log('✓ PDF descargado exitosamente:', nombreArchivo);
                alert('PDF generado exitosamente con imagen de Flickr');
            };
            
            // Cargar la imagen específica
            img.src = 'https://live.staticflickr.com/65535/54810012523_d9377c1fc4_b.jpg';
            
            // Timeout de 8 segundos para evitar esperas largas
            setTimeout(() => {
                if (!img.complete) {
                    console.log('⏱️ Timeout: Generando PDF sin imagen externa');
                    img.onerror();
                }
            }, 8000);
        }
        
        // Hacer las funciones disponibles globalmente
        window.generarPDF = generarPDF;
        window.generarPDFConMapa = generarPDFConMapa;
    </script>
    
    <!-- Librerías para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
